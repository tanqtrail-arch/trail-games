<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRAIL Êé¢Á©∂„Ç≤„Éº„É†„É©„É≥„Éâ</title>
<meta name="description" content="Êé¢Á©∂ÊïôÂÆ§TRAIL„ÅÆÂ≠¶Áøí„Ç≤„Éº„É†„Éù„Éº„Çø„É´„ÄÇÊÄùËÄÉÂäõ„ÉªÁêÜÁßë„ÉªÁ§æ‰ºö„ÉªÁÆóÊï∞„ÉªÂâµÈÄ†Âäõ„ÇíÈÅä„Å≥„Å™„Åå„ÇâÂ≠¶„Åπ„Çã„Ç≤„Éº„É†„ÅåÈõÜ„Åæ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ">
<meta property="og:title" content="TRAIL Êé¢Á©∂„Ç≤„Éº„É†„É©„É≥„Éâ">
<meta property="og:description" content="„ÅÇ„Åù„Çì„Åß „Åæ„Å™„Çì„Åß Áô∫Ë¶ã„Åó„Çà„ÅÜÔºÅÊé¢Á©∂ÊïôÂÆ§TRAIL„ÅÆÂ≠¶Áøí„Ç≤„Éº„É†„Éù„Éº„Çø„É´„ÄÇ">
<meta property="og:type" content="website">
<meta property="og:locale" content="ja_JP">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå≤</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=Fredoka:wght@400;600;700&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-cream: #fef9ef;
    --trail-green: #2d9a4e;
    --trail-green-light: #5ec97a;
    --trail-green-dark: #1d7a3a;
    --sun-yellow: #ffd23f;
    --berry-pink: #ff6b8a;
    --text-dark: #2c3e2d;
    --text-mid: #5a6b5c;
    --text-light: #8a9b8c;
    --card-white: #ffffff;
    --sidebar-width: 280px;
    --header-height: 56px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Zen Maru Gothic', sans-serif;
    background: var(--bg-cream);
    color: var(--text-dark);
    min-height: 100vh;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
  }

  /* === App Layout === */
  .app-shell { display: flex; height: 100vh; width: 100vw; }

  /* === Sidebar === */
  .sidebar {
    width: var(--sidebar-width);
    height: 100vh;
    background: linear-gradient(180deg, #ffffff 0%, #f8fdf9 100%);
    border-right: 1px solid rgba(45,154,78,0.12);
    display: flex; flex-direction: column;
    flex-shrink: 0;
    z-index: 50;
    transition: transform 0.3s ease;
  }
  .sidebar-header {
    padding: 18px 20px 14px;
    border-bottom: 1px solid rgba(45,154,78,0.08);
    text-align: center;
    cursor: pointer;
  }
  .sidebar-header:hover { background: rgba(45,154,78,0.03); }
  .sidebar-logo-row { display: flex; align-items: center; justify-content: center; gap: 8px; }
  .sidebar-logo-icon { font-size: 24px; }
  .sidebar-logo-text { font-family: 'Fredoka', sans-serif; font-size: 18px; font-weight: 700; color: var(--trail-green); letter-spacing: 3px; }
  .sidebar-subtitle { font-size: 11px; color: var(--text-mid); font-weight: 700; margin-top: 2px; }

  .sidebar-nav { flex: 1; overflow-y: auto; padding: 12px 12px; }
  .sidebar-nav::-webkit-scrollbar { width: 4px; }
  .sidebar-nav::-webkit-scrollbar-thumb { background: rgba(45,154,78,0.2); border-radius: 4px; }

  .nav-section { margin-bottom: 18px; }
  .nav-section-title {
    font-size: 10px; font-weight: 900; color: var(--text-light);
    text-transform: uppercase; letter-spacing: 2px;
    padding: 0 10px; margin-bottom: 6px;
  }
  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px; border-radius: 12px;
    cursor: pointer; transition: all 0.2s ease;
    border: none; background: none; width: 100%;
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 13px; font-weight: 700; color: var(--text-mid);
    text-align: left;
  }
  .nav-item:hover { background: rgba(45,154,78,0.06); color: var(--text-dark); }
  .nav-item.active { background: rgba(45,154,78,0.1); color: var(--trail-green); }
  .nav-item .nav-icon { font-size: 18px; width: 24px; text-align: center; flex-shrink: 0; }
  .nav-item .nav-label { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .nav-item .nav-badge {
    font-size: 10px; padding: 2px 8px; border-radius: 10px;
    background: var(--berry-pink); color: white;
    font-family: 'Fredoka', sans-serif; font-weight: 600;
  }

  /* Category filter items */
  .cat-item {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 12px; border-radius: 10px;
    cursor: pointer; transition: all 0.2s ease;
    border: none; background: none; width: 100%;
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 12px; font-weight: 700; color: var(--text-mid);
    text-align: left;
  }
  .cat-item:hover { background: rgba(45,154,78,0.06); }
  .cat-item.active { background: var(--trail-green); color: white; border-radius: 10px; }
  .cat-item .cat-count {
    margin-left: auto; font-size: 11px; opacity: 0.6;
    font-family: 'Fredoka', sans-serif;
  }

  .sidebar-footer {
    padding: 14px 16px; border-top: 1px solid rgba(45,154,78,0.08);
    text-align: center; font-size: 10px; color: var(--text-light);
  }
  .sidebar-footer .brand { color: var(--trail-green); font-weight: 900; }

  /* === Main Content Area === */
  .main-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }

  /* === Top Bar === */
  .top-bar {
    height: var(--header-height);
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid rgba(45,154,78,0.1);
    display: flex; align-items: center; padding: 0 20px;
    flex-shrink: 0; z-index: 40;
  }
  .menu-toggle {
    display: none; border: none; background: none; cursor: pointer;
    font-size: 22px; padding: 6px; margin-right: 10px; border-radius: 8px;
    color: var(--text-dark);
  }
  .menu-toggle:hover { background: rgba(45,154,78,0.08); }
  .breadcrumb { display: flex; align-items: center; gap: 6px; flex: 1; }
  .breadcrumb-item {
    font-size: 13px; font-weight: 700; color: var(--text-mid);
    cursor: pointer; border: none; background: none;
    font-family: 'Zen Maru Gothic', sans-serif;
    padding: 4px 8px; border-radius: 8px; transition: all 0.2s;
  }
  .breadcrumb-item:hover { background: rgba(45,154,78,0.08); color: var(--trail-green); }
  .breadcrumb-item.current { color: var(--text-dark); cursor: default; }
  .breadcrumb-item.current:hover { background: none; color: var(--text-dark); }
  .breadcrumb-sep { font-size: 11px; color: var(--text-light); }
  .top-bar-actions { display: flex; gap: 8px; align-items: center; }
  .top-bar-btn {
    border: none; background: rgba(45,154,78,0.08); cursor: pointer;
    font-size: 16px; padding: 8px 12px; border-radius: 10px;
    color: var(--text-dark); transition: all 0.2s;
    font-family: 'Zen Maru Gothic', sans-serif; font-weight: 700; font-size: 12px;
    display: flex; align-items: center; gap: 6px;
  }
  .top-bar-btn:hover { background: rgba(45,154,78,0.15); }
  .top-bar-btn.active { background: var(--trail-green); color: white; }

  /* === Content Views === */
  .content-area { flex: 1; overflow: hidden; position: relative; }

  /* --- Game List View --- */
  .view-game-list {
    height: 100%; overflow-y: auto;
    padding: 0;
  }
  .view-game-list::-webkit-scrollbar { width: 6px; }
  .view-game-list::-webkit-scrollbar-thumb { background: rgba(45,154,78,0.15); border-radius: 4px; }

  .game-list-header {
    padding: 28px 32px 16px;
    background: linear-gradient(135deg, rgba(45,154,78,0.06), rgba(255,210,63,0.04));
  }
  .game-list-header h2 { font-size: 22px; font-weight: 900; color: var(--text-dark); }
  .game-list-header h2 span { color: var(--trail-green); }
  .game-list-header p { font-size: 13px; color: var(--text-mid); margin-top: 4px; }
  .game-count-bar {
    display: flex; align-items: center; gap: 12px; margin-top: 14px;
    padding: 10px 16px; background: white; border-radius: 12px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  }
  .game-count-bar .count-num {
    font-family: 'Fredoka', sans-serif; font-size: 28px; font-weight: 700;
    color: var(--trail-green);
  }
  .game-count-bar .count-label { font-size: 12px; color: var(--text-mid); font-weight: 700; }

  .game-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 18px; padding: 20px 32px 60px;
  }

  /* === Game Card === */
  .game-card {
    position: relative; border-radius: 18px; overflow: hidden;
    background: var(--card-white);
    box-shadow: 0 2px 12px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.03);
    cursor: pointer; transition: transform 0.25s ease, box-shadow 0.25s ease;
    animation: cardPop 0.4s ease both;
    outline: none;
  }
  .game-card:hover { transform: translateY(-4px); box-shadow: 0 8px 28px rgba(0,0,0,0.10); }
  .game-card:active { transform: scale(0.98); }
  .game-card:focus-visible { outline: 3px solid var(--trail-green); outline-offset: 2px; }
  @keyframes cardPop { from { opacity: 0; transform: translateY(20px) scale(0.97); } to { opacity: 1; transform: translateY(0) scale(1); } }

  .card-visual { position: relative; height: 110px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
  .card-visual .emoji-icon { font-size: 46px; position: relative; z-index: 2; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.15)); animation: iconFloat 3s ease-in-out infinite; }
  @keyframes iconFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
  .card-visual .bg-deco { position: absolute; inset: 0; }
  .deco-wave { position: absolute; bottom: -2px; left: 0; right: 0; height: 16px; background: var(--card-white); border-radius: 16px 16px 0 0; }
  .deco-trees { position: absolute; bottom: 0; left: 0; right: 0; font-size: 18px; text-align: center; opacity: 0.2; letter-spacing: 6px; line-height: 1; padding-bottom: 5px; }
  .deco-dots { position: absolute; width: 100%; height: 100%; opacity: 0.3; }
  .deco-dots::before { content: '\00B7 \00B7 \00B7 \00B7 \00B7'; position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 12px; letter-spacing: 4px; color: rgba(255,255,255,0.5); white-space: nowrap; }

  .card-body { padding: 12px 16px 14px; }
  .card-tags { display: flex; gap: 5px; margin-bottom: 6px; flex-wrap: wrap; }
  .tag { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 8px; letter-spacing: 0.3px; }
  .card-title { font-size: 16px; font-weight: 900; margin-bottom: 4px; line-height: 1.3; }
  .card-desc { font-size: 11.5px; color: var(--text-mid); line-height: 1.6; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .card-footer { display: flex; align-items: center; justify-content: space-between; }
  .card-difficulty { display: flex; gap: 3px; align-items: center; }
  .card-difficulty .label { font-size: 10px; color: var(--text-mid); margin-right: 3px; font-weight: 700; }
  .trail-marker { width: 10px; height: 10px; border-radius: 3px; background: #e8ede9; }
  .trail-marker.filled { background: var(--sun-yellow); box-shadow: 0 1px 3px rgba(255,210,63,0.4); }
  .play-btn {
    display: flex; align-items: center; gap: 4px; padding: 7px 16px;
    border-radius: 12px; border: none; font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 12px; font-weight: 900; color: white; cursor: pointer;
    transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.10); letter-spacing: 0.5px;
  }
  .play-btn:active { transform: scale(0.93); }
  .card-best-score {
    display: flex; align-items: center; gap: 4px;
    font-size: 10px; color: var(--sun-yellow); font-weight: 700;
    margin-top: 8px; padding-top: 8px; border-top: 1px solid #f0f2f0;
  }

  /* Badges */
  .badge-new {
    position: absolute; top: 8px; right: 8px; z-index: 5;
    font-family: 'Fredoka', sans-serif; font-size: 10px; font-weight: 700;
    padding: 3px 10px; border-radius: 8px; background: var(--berry-pink); color: white;
    box-shadow: 0 2px 6px rgba(255,107,138,0.3);
  }
  .coming-soon-badge {
    position: absolute; top: 8px; right: 8px; z-index: 5;
    font-family: 'Fredoka', sans-serif; font-size: 10px; font-weight: 700;
    padding: 3px 10px; border-radius: 8px; background: #a0a8a2; color: white;
  }

  /* Themes */
  .theme-forest .card-visual { background: linear-gradient(135deg, #c8f0d4, #a8e6b8, #8dd99c); }
  .theme-forest .tag { background: #d4f5de; color: #1a7a3a; }
  .theme-forest .play-btn { background: linear-gradient(135deg, #2d9a4e, #3ab85c); }
  .theme-forest .card-title { color: #1a6b35; }
  .theme-sunset .card-visual { background: linear-gradient(135deg, #ffe0c8, #ffc9a8, #ffb088); }
  .theme-sunset .tag { background: #ffe8d6; color: #c45a10; }
  .theme-sunset .play-btn { background: linear-gradient(135deg, #ff8c42, #ff6b3a); }
  .theme-sunset .card-title { color: #b34a0a; }
  .theme-ocean .card-visual { background: linear-gradient(135deg, #c8e8ff, #a8d8f8, #88c8f0); }
  .theme-ocean .tag { background: #d6eeff; color: #1a6da0; }
  .theme-ocean .play-btn { background: linear-gradient(135deg, #3a9fd5, #5cb8e6); }
  .theme-ocean .card-title { color: #185a85; }
  .theme-berry .card-visual { background: linear-gradient(135deg, #ffd6e0, #ffc0cf, #ffaabe); }
  .theme-berry .tag { background: #ffe0ea; color: #c4305a; }
  .theme-berry .play-btn { background: linear-gradient(135deg, #ff4d78, #ff6b8a); }
  .theme-berry .card-title { color: #a82850; }
  .theme-lavender .card-visual { background: linear-gradient(135deg, #e4d8ff, #d0c0ff, #bca8f8); }
  .theme-lavender .tag { background: #ece4ff; color: #6a4aaf; }
  .theme-lavender .play-btn { background: linear-gradient(135deg, #8b6fc0, #a78bfa); }
  .theme-lavender .card-title { color: #5a3a9a; }
  .theme-earth .card-visual { background: linear-gradient(135deg, #f0e4c8, #e8d8a8, #dcc888); }
  .theme-earth .tag { background: #f5ecd6; color: #8b6914; }
  .theme-earth .play-btn { background: linear-gradient(135deg, #b08a30, #c4a35a); }
  .theme-earth .card-title { color: #6a5010; }
  .theme-gallery .card-visual { background: linear-gradient(135deg, #f5e6c8, #e8d4a8, #d4c090); }
  .theme-gallery .tag { background: #f7ecd8; color: #8a6520; }
  .theme-gallery .play-btn { background: linear-gradient(135deg, #b8860b, #d4a030); }
  .theme-gallery .card-title { color: #6b4c0a; }

  .game-card.coming-soon { opacity: 0.5; }
  .game-card.coming-soon:hover { transform: translateY(-2px); opacity: 0.55; }
  .game-card.coming-soon .play-btn { background: #bbb !important; box-shadow: none; }
  .game-card.coming-soon .emoji-icon { animation: none !important; }
  .game-card.hidden { display: none; }

  /* --- Game Embed View --- */
  .view-game-embed {
    display: none; width: 100%; height: 100%;
    position: relative;
  }
  .view-game-embed.active { display: flex; flex-direction: column; }
  .game-embed-bar {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 20px; background: white;
    border-bottom: 1px solid rgba(45,154,78,0.08);
    flex-shrink: 0;
  }
  .game-embed-bar .back-btn {
    border: none; background: rgba(45,154,78,0.08); cursor: pointer;
    padding: 7px 14px; border-radius: 10px;
    font-family: 'Zen Maru Gothic', sans-serif; font-size: 12px; font-weight: 700;
    color: var(--trail-green); transition: all 0.2s;
    display: flex; align-items: center; gap: 4px;
  }
  .game-embed-bar .back-btn:hover { background: rgba(45,154,78,0.15); }
  .game-embed-bar .game-title {
    font-size: 15px; font-weight: 900; color: var(--text-dark);
    flex: 1; display: flex; align-items: center; gap: 8px;
  }
  .game-embed-bar .game-title .game-emoji { font-size: 20px; }
  .game-embed-bar .fullscreen-btn {
    border: none; background: rgba(45,154,78,0.08); cursor: pointer;
    padding: 7px 12px; border-radius: 10px;
    font-size: 16px; transition: all 0.2s;
  }
  .game-embed-bar .fullscreen-btn:hover { background: rgba(45,154,78,0.15); }
  .game-iframe-wrap { flex: 1; position: relative; overflow: hidden; }
  .game-iframe-wrap iframe {
    width: 100%; height: 100%; border: none;
    background: var(--bg-cream);
  }
  .game-loading-overlay {
    position: absolute; inset: 0; display: flex;
    flex-direction: column; align-items: center; justify-content: center;
    background: var(--bg-cream); z-index: 10;
    transition: opacity 0.3s ease;
  }
  .game-loading-overlay.hidden { opacity: 0; pointer-events: none; }
  .loading-spinner { font-size: 48px; animation: spin 1.5s ease-in-out infinite; }
  @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  .loading-text { font-size: 14px; font-weight: 700; color: var(--text-mid); margin-top: 12px; }

  /* --- Dashboard View --- */
  .view-dashboard {
    display: none; height: 100%; overflow-y: auto; padding: 28px 32px 60px;
  }
  .view-dashboard.active { display: block; }
  .view-dashboard::-webkit-scrollbar { width: 6px; }
  .view-dashboard::-webkit-scrollbar-thumb { background: rgba(45,154,78,0.15); border-radius: 4px; }

  .dash-header { margin-bottom: 24px; }
  .dash-header h2 { font-size: 22px; font-weight: 900; }
  .dash-header h2 span { color: var(--trail-green); }
  .dash-header p { font-size: 13px; color: var(--text-mid); margin-top: 4px; }

  .dash-stats {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 14px; margin-bottom: 28px;
  }
  .stat-card {
    background: white; border-radius: 14px; padding: 18px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.04);
    text-align: center;
  }
  .stat-card .stat-icon { font-size: 28px; margin-bottom: 6px; }
  .stat-card .stat-value {
    font-family: 'Fredoka', sans-serif; font-size: 30px; font-weight: 700;
    color: var(--trail-green);
  }
  .stat-card .stat-label { font-size: 11px; color: var(--text-mid); font-weight: 700; margin-top: 2px; }

  .dash-section { margin-bottom: 28px; }
  .dash-section h3 {
    font-size: 15px; font-weight: 900; color: var(--text-dark);
    margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
  }
  .history-list { display: flex; flex-direction: column; gap: 8px; }
  .history-item {
    display: flex; align-items: center; gap: 12px;
    background: white; border-radius: 12px; padding: 12px 16px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.03);
    cursor: pointer; transition: all 0.2s;
  }
  .history-item:hover { transform: translateX(4px); box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .history-item .h-emoji { font-size: 24px; }
  .history-item .h-info { flex: 1; }
  .history-item .h-title { font-size: 13px; font-weight: 900; }
  .history-item .h-time { font-size: 10px; color: var(--text-light); }
  .history-item .h-score {
    font-family: 'Fredoka', sans-serif; font-size: 18px; font-weight: 700;
    color: var(--trail-green);
  }
  .empty-history {
    text-align: center; padding: 30px; color: var(--text-light);
    font-size: 13px; font-weight: 700;
  }
  .empty-history .empty-emoji { font-size: 36px; margin-bottom: 8px; opacity: 0.5; }

  /* === Empty State === */
  .empty-state {
    text-align: center; padding: 40px 20px;
    color: var(--text-mid); font-size: 14px; font-weight: 700;
    grid-column: 1 / -1;
  }
  .empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }

  /* === Toast === */
  .toast-msg {
    position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%);
    background: white; color: var(--text-dark); padding: 14px 26px; border-radius: 18px;
    font-size: 14px; font-weight: 700; z-index: 999;
    border: 2px solid var(--trail-green-light);
    box-shadow: 0 6px 24px rgba(45,154,78,0.15);
    animation: toastUp 0.3s ease, toastDown 0.3s ease 2s forwards;
  }
  @keyframes toastUp { from{opacity:0;transform:translateX(-50%) translateY(16px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
  @keyframes toastDown { from{opacity:1} to{opacity:0;transform:translateX(-50%) translateY(16px)} }

  /* === Mobile Overlay === */
  .sidebar-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.3); z-index: 45;
  }

  /* === Mobile Responsive === */
  @media (max-width: 768px) {
    :root { --sidebar-width: 260px; }
    .sidebar {
      position: fixed; left: 0; top: 0; bottom: 0;
      transform: translateX(-100%); z-index: 50;
      box-shadow: 4px 0 24px rgba(0,0,0,0.1);
    }
    .sidebar.open { transform: translateX(0); }
    .sidebar-overlay.open { display: block; }
    .menu-toggle { display: block; }
    .game-grid { grid-template-columns: 1fr; padding: 16px; gap: 14px; }
    .game-list-header { padding: 20px 16px 12px; }
    .view-dashboard { padding: 20px 16px 60px; }
    .dash-stats { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 480px) {
    .game-embed-bar .game-title { font-size: 13px; }
  }
</style>
</head>
<body>

<div class="app-shell">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header" onclick="showView('games')">
      <div class="sidebar-logo-row">
        <span class="sidebar-logo-icon">üå≤</span>
        <span class="sidebar-logo-text">TRAIL</span>
        <span class="sidebar-logo-icon">üå≤</span>
      </div>
      <div class="sidebar-subtitle">Êé¢Á©∂„Ç≤„Éº„É†„É©„É≥„Éâ</div>
    </div>

    <nav class="sidebar-nav" id="sidebarNav">
      <div class="nav-section">
        <div class="nav-section-title">„É°„Éã„É•„Éº</div>
        <button class="nav-item active" data-view="games" onclick="showView('games')">
          <span class="nav-icon">üéÆ</span>
          <span class="nav-label">„Ç≤„Éº„É†‰∏ÄË¶ß</span>
        </button>
        <button class="nav-item" data-view="dashboard" onclick="showView('dashboard')">
          <span class="nav-icon">üìä</span>
          <span class="nav-label">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</span>
        </button>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">„Ç´„ÉÜ„Ç¥„É™</div>
        <div id="categoryNav"></div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">„Ç≤„Éº„É†</div>
        <div id="gameNav"></div>
      </div>
    </nav>

    <div class="sidebar-footer">
      <span class="brand">Êé¢Á©∂ÊïôÂÆ§ TRAIL</span> &middot; „ÅÇ„Åù„Çì„Åß „Åæ„Å™„Çì„Åß Áô∫Ë¶ã„Åó„Çà„ÅÜÔºÅ
    </div>
  </aside>

  <!-- Sidebar mobile overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- Main Area -->
  <div class="main-area">
    <!-- Top Bar -->
    <div class="top-bar">
      <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">‚ò∞</button>
      <div class="breadcrumb" id="breadcrumb">
        <button class="breadcrumb-item current">üå≤ „Ç≤„Éº„É†‰∏ÄË¶ß</button>
      </div>
      <div class="top-bar-actions">
        <button class="top-bar-btn" onclick="showView('dashboard')" title="„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ">üìä „Åç„Çç„Åè</button>
      </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
      <!-- Game List View -->
      <div class="view-game-list" id="viewGameList">
        <div class="game-list-header">
          <h2>üå≤ <span>Êé¢Á©∂</span>„Ç≤„Éº„É†„É©„É≥„Éâ</h2>
          <p>„ÅÇ„Åù„Çì„Åß „Åæ„Å™„Çì„Åß Áô∫Ë¶ã„Åó„Çà„ÅÜÔºÅ</p>
          <div class="game-count-bar">
            <div class="count-num" id="visibleCount">0</div>
            <div class="count-label" id="countLabel"></div>
          </div>
        </div>
        <div class="game-grid" id="gameGrid"></div>
      </div>

      <!-- Game Embed View -->
      <div class="view-game-embed" id="viewGameEmbed">
        <div class="game-embed-bar">
          <button class="back-btn" onclick="showView('games')">‚Üê „ÇÇ„Å©„Çã</button>
          <div class="game-title">
            <span class="game-emoji" id="embedGameEmoji"></span>
            <span id="embedGameTitle"></span>
          </div>
          <button class="fullscreen-btn" onclick="toggleFullscreen()" title="„Éï„É´„Çπ„ÇØ„É™„Éº„É≥">‚õ∂</button>
        </div>
        <div class="game-iframe-wrap">
          <div class="game-loading-overlay" id="gameLoading">
            <div class="loading-spinner">üå≤</div>
            <div class="loading-text">„Ç≤„Éº„É†„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
          </div>
          <iframe id="gameIframe" sandbox="allow-scripts allow-same-origin allow-popups" title="„Ç≤„Éº„É†"></iframe>
        </div>
      </div>

      <!-- Dashboard View -->
      <div class="view-dashboard" id="viewDashboard">
        <div class="dash-header">
          <h2>üìä <span>„Åç„Åø„ÅÆ</span>„Åç„Çç„Åè</h2>
          <p>„Åì„Çå„Åæ„Åß„ÅÆ„Éó„É¨„Ç§Ë®òÈå≤„Å®ÊàêÁ∏æ„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºÅ</p>
        </div>
        <div class="dash-stats" id="dashStats"></div>
        <div class="dash-section">
          <h3>üïê „Åï„ÅÑ„Åç„Çì„ÅÆ„Éó„É¨„Ç§</h3>
          <div class="history-list" id="historyList"></div>
        </div>
        <div class="dash-section">
          <h3>üèÜ „Éô„Çπ„Éà„Çπ„Ç≥„Ç¢</h3>
          <div class="history-list" id="bestScoreList"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="shared/game-registry.js"></script>
<script>
// =====================================================
// TRAIL SaaS App Shell
// =====================================================

var games = TRAIL_GAMES;
var categories = TRAIL_CATEGORIES;
var currentView = 'games';
var currentCategory = 'all';
var currentGame = null;

// === Init ===
(function init() {
  renderCategoryNav();
  renderGameNav();
  renderGameGrid();
  filterCards('all');
  renderDashboard();
  listenForGameMessages();
})();

// === Sidebar Category Nav ===
function renderCategoryNav() {
  var container = document.getElementById('categoryNav');
  var html = '';
  categories.forEach(function(cat) {
    var count = cat.id === 'all'
      ? games.filter(function(g) { return !g.comingSoon; }).length
      : games.filter(function(g) { return g.category === cat.id && !g.comingSoon; }).length;
    html += '<button class="cat-item' + (cat.id === 'all' ? ' active' : '') + '" data-cat="' + cat.id + '" onclick="filterByCategory(\'' + cat.id + '\')">'
          + cat.label
          + '<span class="cat-count">' + count + '</span>'
          + '</button>';
  });
  container.innerHTML = html;
}

// === Sidebar Game Quick Nav ===
function renderGameNav() {
  var container = document.getElementById('gameNav');
  var playable = games.filter(function(g) { return !g.comingSoon && g.url; });
  var html = '';
  playable.forEach(function(game) {
    html += '<button class="nav-item" data-game="' + game.id + '" onclick="launchGame(\'' + game.id + '\')">'
          + '<span class="nav-icon">' + game.emoji + '</span>'
          + '<span class="nav-label">' + game.title + '</span>'
          + '</button>';
  });
  container.innerHTML = html;
}

// === Game Grid ===
function renderGameGrid() {
  var grid = document.getElementById('gameGrid');
  grid.innerHTML = '';
  games.forEach(function(game, idx) {
    var card = document.createElement('div');
    card.className = 'game-card theme-' + game.theme + (game.comingSoon ? ' coming-soon' : '');
    card.dataset.cat = game.category;
    card.dataset.id = game.id;
    card.style.animationDelay = (idx * 0.04) + 's';
    card.setAttribute('tabindex', '0');
    card.setAttribute('role', 'link');
    card.setAttribute('aria-label', game.title + (game.comingSoon ? 'ÔºàÊ∫ñÂÇô‰∏≠Ôºâ' : ''));

    var badge = '';
    if (game.isNew && !game.comingSoon) badge = '<div class="badge-new">NEW!</div>';
    else if (game.comingSoon) badge = '<div class="coming-soon-badge">Ê∫ñÂÇô‰∏≠</div>';

    var deco = game.decoType === 'trees'
      ? '<div class="deco-trees">' + (game.decoContent || '') + '</div>'
      : '<div class="deco-dots"></div>';

    var markers = '';
    for (var i = 1; i <= 5; i++) {
      markers += '<div class="trail-marker' + (i <= game.difficulty ? ' filled' : '') + '"></div>';
    }

    var tagsHtml = game.tags.map(function(t) { return '<span class="tag">' + t + '</span>'; }).join('');
    var btnText = game.comingSoon ? 'üîí Ê∫ñÂÇô‰∏≠' : '‚ñ∂ „ÅÇ„Åù„Å∂ÔºÅ';

    // Best score display
    var bestHtml = '';
    var best = getBestScore(game.id);
    if (best) {
      bestHtml = '<div class="card-best-score">üèÜ „Éô„Çπ„Éà: ' + best.score + 'ÁÇπ</div>';
    }

    card.innerHTML =
      badge +
      '<div class="card-visual">' +
        '<div class="bg-deco">' + deco + '</div>' +
        '<div class="deco-wave"></div>' +
        '<div class="emoji-icon">' + game.emoji + '</div>' +
      '</div>' +
      '<div class="card-body">' +
        '<div class="card-tags">' + tagsHtml + '</div>' +
        '<div class="card-title">' + game.title + '</div>' +
        '<div class="card-desc">' + game.desc + '</div>' +
        '<div class="card-footer">' +
          '<div class="card-difficulty"><span class="label">„ÇÄ„Åö„Åã„Åó„Åï</span>' + markers + '</div>' +
          '<button class="play-btn">' + btnText + '</button>' +
        '</div>' +
        bestHtml +
      '</div>';

    card.addEventListener('click', function() { launchGame(game.id); });
    card.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); launchGame(game.id); }
    });

    grid.appendChild(card);
  });
}

// === Filter ===
function filterByCategory(cat) {
  currentCategory = cat;

  // Update sidebar active state
  var catItems = document.querySelectorAll('.cat-item');
  catItems.forEach(function(item) {
    item.classList.toggle('active', item.dataset.cat === cat);
  });

  filterCards(cat);
  if (currentView !== 'games') showView('games');
  closeSidebar();
}

function filterCards(cat) {
  var cards = document.querySelectorAll('.game-card');
  var playable = 0, comingSoonCount = 0, totalVisible = 0;

  cards.forEach(function(card) {
    if (cat === 'all' || card.dataset.cat === cat) {
      card.classList.remove('hidden');
      totalVisible++;
      var game = games.find(function(g) { return g.id === card.dataset.id; });
      if (game && !game.comingSoon) playable++;
      else comingSoonCount++;
    } else {
      card.classList.add('hidden');
    }
  });

  document.getElementById('visibleCount').textContent = totalVisible;
  var countLabel = document.getElementById('countLabel');

  // Remove old empty state
  var oldEmpty = document.getElementById('emptyState');
  if (oldEmpty) oldEmpty.remove();

  if (totalVisible === 0) {
    countLabel.textContent = '';
    var grid = document.getElementById('gameGrid');
    var el = document.createElement('div');
    el.className = 'empty-state'; el.id = 'emptyState';
    el.innerHTML = '<div class="empty-icon">üåø</div><div>„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Ç≤„Éº„É†„ÅØ<br>„Åæ„Å†„Å™„ÅÑ„Çà„ÄÇ„Åä„Åü„ÅÆ„Åó„Åø„Å´ÔºÅ</div>';
    grid.appendChild(el);
  } else if (comingSoonCount > 0 && playable > 0) {
    countLabel.textContent = '„Å§„ÅÆ„Ç≤„Éº„É†ÔºÅÔºà' + playable + '„Å§„ÅÇ„Åù„Åπ„Çã„Éª' + comingSoonCount + '„Å§Ê∫ñÂÇô‰∏≠Ôºâ';
  } else if (playable === 0) {
    countLabel.textContent = '„Å§„ÅÆ„Ç≤„Éº„É†„ÅåÊ∫ñÂÇô‰∏≠ üöß';
  } else {
    countLabel.textContent = '„Å§„ÅÆ„Ç≤„Éº„É†„Åß„ÅÇ„Åù„Åπ„Çã„ÇàÔºÅüö©';
  }
}

// === Launch Game ===
function launchGame(gameId) {
  var game = games.find(function(g) { return g.id === gameId; });
  if (!game) return;

  if (game.comingSoon) {
    showToast('üå± „Äå' + game.title + '„Äç„ÅØÊ∫ñÂÇô‰∏≠„Å†„ÇàÔºÅ„Åä„Åü„ÅÆ„Åó„Åø„Å´ÔºÅ');
    return;
  }
  if (!game.url) {
    showToast('üå± „Äå' + game.title + '„Äç„ÅØ„Åæ„ÇÇ„Å™„ÅèÂÖ¨ÈñãÔºÅ');
    return;
  }

  // External games open in new tab
  if (game.external) {
    window.open(game.url, '_blank');
    return;
  }

  // Embed internal game
  currentGame = game;
  document.getElementById('embedGameEmoji').textContent = game.emoji;
  document.getElementById('embedGameTitle').textContent = game.title;

  var iframe = document.getElementById('gameIframe');
  var loading = document.getElementById('gameLoading');
  loading.classList.remove('hidden');

  iframe.onload = function() {
    loading.classList.add('hidden');
  };
  iframe.src = game.url;

  showView('embed');
  closeSidebar();

  // Update sidebar game nav active
  document.querySelectorAll('[data-game]').forEach(function(item) {
    item.classList.toggle('active', item.dataset.game === gameId);
  });
}

// === View Management ===
function showView(view) {
  currentView = view;

  // Hide all views
  document.getElementById('viewGameList').style.display = 'none';
  document.getElementById('viewGameEmbed').classList.remove('active');
  document.getElementById('viewDashboard').classList.remove('active');

  // Show target view
  if (view === 'games') {
    document.getElementById('viewGameList').style.display = '';
    updateBreadcrumb([{ label: 'üå≤ „Ç≤„Éº„É†‰∏ÄË¶ß', action: null }]);
    // Unload iframe
    var iframe = document.getElementById('gameIframe');
    if (iframe.src && iframe.src !== 'about:blank') iframe.src = 'about:blank';
    currentGame = null;
    // Clear game nav active
    document.querySelectorAll('[data-game]').forEach(function(item) { item.classList.remove('active'); });
  } else if (view === 'embed') {
    document.getElementById('viewGameEmbed').classList.add('active');
    updateBreadcrumb([
      { label: 'üå≤ „Ç≤„Éº„É†‰∏ÄË¶ß', action: function() { showView('games'); } },
      { label: currentGame ? currentGame.emoji + ' ' + currentGame.title : '' , action: null }
    ]);
  } else if (view === 'dashboard') {
    document.getElementById('viewDashboard').classList.add('active');
    renderDashboard();
    updateBreadcrumb([{ label: 'üìä „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ', action: null }]);
  }

  // Update nav active states
  document.querySelectorAll('.nav-item[data-view]').forEach(function(item) {
    item.classList.toggle('active', item.dataset.view === view || (view === 'embed' && item.dataset.view === 'games'));
  });
}

// === Breadcrumb ===
function updateBreadcrumb(items) {
  var bc = document.getElementById('breadcrumb');
  bc.innerHTML = '';
  items.forEach(function(item, idx) {
    if (idx > 0) {
      var sep = document.createElement('span');
      sep.className = 'breadcrumb-sep';
      sep.textContent = '‚Ä∫';
      bc.appendChild(sep);
    }
    var btn = document.createElement('button');
    btn.className = 'breadcrumb-item' + (idx === items.length - 1 ? ' current' : '');
    btn.textContent = item.label;
    if (item.action) {
      btn.addEventListener('click', item.action);
    }
    bc.appendChild(btn);
  });
}

// === Sidebar Mobile ===
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('open');
}

// === Fullscreen ===
function toggleFullscreen() {
  var wrap = document.getElementById('viewGameEmbed');
  if (document.fullscreenElement) {
    document.exitFullscreen();
  } else {
    wrap.requestFullscreen().catch(function() {});
  }
}

// === Dashboard ===
function renderDashboard() {
  renderDashStats();
  renderHistory();
  renderBestScores();
}

function renderDashStats() {
  var container = document.getElementById('dashStats');
  var totalPlays = 0;
  var gamesPlayed = new Set();
  var totalScore = 0;
  var bestScore = 0;

  games.forEach(function(game) {
    var history = getHistory(game.id);
    if (history.length > 0) {
      gamesPlayed.add(game.id);
      totalPlays += history.length;
      history.forEach(function(h) {
        totalScore += (h.score || 0);
        if ((h.score || 0) > bestScore) bestScore = h.score;
      });
    }
  });

  var playableCount = games.filter(function(g) { return !g.comingSoon && g.url; }).length;

  container.innerHTML =
    '<div class="stat-card"><div class="stat-icon">üéÆ</div><div class="stat-value">' + totalPlays + '</div><div class="stat-label">„Éà„Éº„Çø„É´„Éó„É¨„Ç§</div></div>' +
    '<div class="stat-card"><div class="stat-icon">üó∫Ô∏è</div><div class="stat-value">' + gamesPlayed.size + '/' + playableCount + '</div><div class="stat-label">„Éó„É¨„Ç§„Åó„Åü„Ç≤„Éº„É†</div></div>' +
    '<div class="stat-card"><div class="stat-icon">‚≠ê</div><div class="stat-value">' + totalScore + '</div><div class="stat-label">„Åî„ÅÜ„Åë„ÅÑ„Çπ„Ç≥„Ç¢</div></div>' +
    '<div class="stat-card"><div class="stat-icon">üèÜ</div><div class="stat-value">' + bestScore + '</div><div class="stat-label">„Éô„Çπ„Éà„Çπ„Ç≥„Ç¢</div></div>';
}

function renderHistory() {
  var container = document.getElementById('historyList');
  var allHistory = [];

  games.forEach(function(game) {
    var history = getHistory(game.id);
    history.forEach(function(h) {
      allHistory.push({ game: game, score: h.score, timestamp: h.timestamp });
    });
  });

  allHistory.sort(function(a, b) { return b.timestamp - a.timestamp; });
  allHistory = allHistory.slice(0, 20);

  if (allHistory.length === 0) {
    container.innerHTML = '<div class="empty-history"><div class="empty-emoji">üå±</div>„Åæ„Å†„Éó„É¨„Ç§Ë®òÈå≤„Åå„Å™„ÅÑ„Çà„ÄÇ<br>„Ç≤„Éº„É†„Åß„ÅÇ„Åù„Çì„Åß„Åø„Çà„ÅÜÔºÅ</div>';
    return;
  }

  container.innerHTML = allHistory.map(function(h) {
    var timeStr = formatTime(h.timestamp);
    return '<div class="history-item" onclick="launchGame(\'' + h.game.id + '\')">' +
      '<span class="h-emoji">' + h.game.emoji + '</span>' +
      '<div class="h-info"><div class="h-title">' + h.game.title + '</div><div class="h-time">' + timeStr + '</div></div>' +
      '<div class="h-score">' + (h.score || 0) + '</div>' +
    '</div>';
  }).join('');
}

function renderBestScores() {
  var container = document.getElementById('bestScoreList');
  var bestScores = [];

  games.forEach(function(game) {
    var best = getBestScore(game.id);
    if (best) {
      bestScores.push({ game: game, score: best.score, timestamp: best.timestamp });
    }
  });

  bestScores.sort(function(a, b) { return b.score - a.score; });

  if (bestScores.length === 0) {
    container.innerHTML = '<div class="empty-history"><div class="empty-emoji">üèÜ</div>„Åæ„Å†„Éô„Çπ„Éà„Çπ„Ç≥„Ç¢„Åå„Å™„ÅÑ„Çà„ÄÇ<br>„Ç≤„Éº„É†„Å´ÊåëÊà¶„Åó„Çà„ÅÜÔºÅ</div>';
    return;
  }

  container.innerHTML = bestScores.map(function(h, idx) {
    var medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : '„ÄÄ';
    return '<div class="history-item" onclick="launchGame(\'' + h.game.id + '\')">' +
      '<span class="h-emoji">' + medal + '</span>' +
      '<div class="h-info"><div class="h-title">' + h.game.emoji + ' ' + h.game.title + '</div></div>' +
      '<div class="h-score">' + h.score + '</div>' +
    '</div>';
  }).join('');
}

// === postMessage Listener (Shell side) ===
function listenForGameMessages() {
  window.addEventListener('message', function(e) {
    var msg = e.data;
    if (!msg || typeof msg.type !== 'string') return;

    switch (msg.type) {
      case 'trail:ready':
        // Game has loaded and initialized
        break;

      case 'trail:score':
        // Mid-game score update (could show in top bar)
        break;

      case 'trail:gameOver':
        // Game finished ‚Äî save to history
        if (msg.gameId && msg.data) {
          saveHistory(msg.gameId, msg.data);
          // Re-render dashboard data & card best scores
          renderDashboard();
          refreshCardBestScores();
        }
        break;

      case 'trail:navigate':
        if (msg.target === 'home') {
          showView('games');
        } else {
          launchGame(msg.target);
        }
        break;

      case 'trail:resize':
        // Could auto-resize iframe if needed
        break;
    }
  });
}

// === LocalStorage Helpers ===
function getHistory(gameId) {
  try {
    var raw = localStorage.getItem('trail:history:' + gameId);
    return raw ? JSON.parse(raw) : [];
  } catch(e) { return []; }
}

function getBestScore(gameId) {
  var history = getHistory(gameId);
  if (history.length === 0) return null;
  var best = history[0];
  for (var i = 1; i < history.length; i++) {
    if ((history[i].score || 0) > (best.score || 0)) best = history[i];
  }
  return best;
}

function saveHistory(gameId, data) {
  var key = 'trail:history:' + gameId;
  try {
    var history = JSON.parse(localStorage.getItem(key) || '[]');
    history.unshift({
      score: data.score || 0,
      correct: data.correct,
      total: data.total,
      timestamp: Date.now()
    });
    if (history.length > 50) history = history.slice(0, 50);
    localStorage.setItem(key, JSON.stringify(history));
  } catch(e) {}
}

function refreshCardBestScores() {
  document.querySelectorAll('.game-card').forEach(function(card) {
    var gameId = card.dataset.id;
    var existing = card.querySelector('.card-best-score');
    var best = getBestScore(gameId);
    if (best) {
      if (existing) {
        existing.innerHTML = 'üèÜ „Éô„Çπ„Éà: ' + best.score + 'ÁÇπ';
      } else {
        var div = document.createElement('div');
        div.className = 'card-best-score';
        div.innerHTML = 'üèÜ „Éô„Çπ„Éà: ' + best.score + 'ÁÇπ';
        card.querySelector('.card-body').appendChild(div);
      }
    }
  });
}

// === Utilities ===
function formatTime(ts) {
  var d = new Date(ts);
  var now = new Date();
  var diffMs = now - d;
  var diffMin = Math.floor(diffMs / 60000);
  if (diffMin < 1) return '„Åü„Å£„Åü„ÅÑ„Åæ';
  if (diffMin < 60) return diffMin + 'ÂàÜ„Åæ„Åà';
  var diffHr = Math.floor(diffMin / 60);
  if (diffHr < 24) return diffHr + 'ÊôÇÈñì„Åæ„Åà';
  var diffDay = Math.floor(diffHr / 24);
  if (diffDay < 7) return diffDay + 'Êó•„Åæ„Åà';
  return (d.getMonth() + 1) + '/' + d.getDate();
}

function showToast(msg) {
  var old = document.querySelector('.toast-msg');
  if (old) old.remove();
  var t = document.createElement('div');
  t.className = 'toast-msg';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(function() { t.remove(); }, 2500);
}

// === Keyboard Shortcuts ===
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    if (currentView === 'embed') showView('games');
    else closeSidebar();
  }
});
</script>
</body>
</html>
