<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TRAIL Game Pro 3</title>
<meta name="description" content="Êé¢Á©∂ÊïôÂÆ§TRAIL„ÅÆÂ≠¶Áøí„Ç≤„Éº„É†„Éù„Éº„Çø„É´">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå≤</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=Fredoka:wght@400;600;700&family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f0f4ff;
    --primary: #4a7cff;
    --primary-dark: #3a5fd9;
    --accent: #ff6b9d;
    --green: #4CAF50;
    --yellow: #FFB300;
    --text: #333;
    --text-light: #888;
    --card-bg: #fff;
    --radius: 16px;
    --shadow: 0 2px 12px rgba(0,0,0,0.08);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'M PLUS Rounded 1c', 'Zen Maru Gothic', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    -webkit-tap-highlight-color: transparent;
    overflow-x: hidden;
  }

  /* === Login Screen === */
  .login-screen {
    min-height: 100vh; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: linear-gradient(160deg, #e8f0fe 0%, #f0f4ff 30%, #fff0f5 70%, #fce4ec 100%);
    padding: 24px;
  }
  .login-box {
    background: white; border-radius: 24px; padding: 32px 28px;
    max-width: 400px; width: 100%;
    box-shadow: 0 8px 40px rgba(74,124,255,0.12), 0 2px 8px rgba(0,0,0,0.04);
    text-align: center;
  }
  .login-logo { font-size: 40px; margin-bottom: 4px; }
  .login-title {
    font-family: 'Fredoka', sans-serif; font-size: 22px; font-weight: 700;
    color: var(--primary); letter-spacing: 1px;
  }
  .login-subtitle {
    font-size: 11px; color: var(--text-light); margin-bottom: 24px;
    font-weight: 700;
  }
  .login-section-label {
    font-size: 13px; font-weight: 800; color: var(--text);
    margin-bottom: 10px; text-align: left;
  }
  .class-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 8px; margin-bottom: 20px;
  }
  .class-btn {
    padding: 12px 8px; border-radius: 12px; border: 2px solid #e8ecf4;
    background: #f8faff; font-family: inherit; font-size: 12px; font-weight: 800;
    color: var(--text); cursor: pointer; transition: all 0.2s;
  }
  .class-btn:hover { border-color: var(--primary); background: #eef3ff; }
  .class-btn.selected { border-color: var(--primary); background: var(--primary); color: white; }
  .login-input {
    width: 100%; padding: 14px 16px; border-radius: 12px;
    border: 2px solid #e8ecf4; font-family: inherit; font-size: 15px;
    font-weight: 700; outline: none; transition: border 0.2s;
    margin-bottom: 16px;
  }
  .login-input:focus { border-color: var(--primary); }
  .login-input::placeholder { color: #bbb; }
  .login-submit {
    width: 100%; padding: 14px; border-radius: 14px; border: none;
    background: linear-gradient(135deg, var(--primary), #6b8fff);
    color: white; font-family: inherit; font-size: 16px; font-weight: 800;
    cursor: pointer; transition: all 0.2s;
    box-shadow: 0 4px 16px rgba(74,124,255,0.3);
  }
  .login-submit:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(74,124,255,0.4); }
  .login-submit:active { transform: scale(0.98); }
  .login-submit:disabled { opacity: 0.5; cursor: default; transform: none; }
  .login-guest {
    display: inline-block; margin-top: 14px; padding: 8px 16px;
    border-radius: 10px; border: none; background: #f0f2f5;
    font-family: inherit; font-size: 12px; font-weight: 700;
    color: var(--text-light); cursor: pointer; transition: all 0.2s;
  }
  .login-guest:hover { background: #e4e8ee; color: var(--text); }
  .login-error { color: var(--accent); font-size: 12px; font-weight: 700; margin-top: 8px; }

  /* Not Registered Popup */
  .popup-overlay {
    display: none; position: fixed; inset: 0; z-index: 9999;
    background: rgba(0,0,0,0.5); align-items: center; justify-content: center;
  }
  .popup-overlay.active { display: flex; }
  .popup-box {
    background: #fff; border-radius: 20px; padding: 32px 28px; text-align: center;
    max-width: 320px; width: 90%; box-shadow: 0 12px 40px rgba(0,0,0,0.25);
    animation: popupIn 0.3s ease;
  }
  @keyframes popupIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .popup-emoji { font-size: 48px; margin-bottom: 8px; }
  .popup-title { font-size: 20px; font-weight: 800; color: var(--text); margin-bottom: 12px; }
  .popup-message { font-size: 15px; color: #555; line-height: 1.7; margin-bottom: 20px; }
  .popup-message strong { color: var(--primary); font-size: 17px; }
  .popup-close-btn {
    background: var(--primary); color: #fff; border: none; border-radius: 12px;
    padding: 10px 32px; font-size: 15px; font-weight: 700; cursor: pointer;
  }
  .popup-close-btn:hover { opacity: 0.9; }

  /* === Main App === */
  .app { display: none; min-height: 100vh; padding-bottom: 70px; }
  .app.active { display: block; }

  /* === Top Header === */
  .top-header {
    background: white;
    padding: 14px 18px; display: flex; align-items: center; gap: 12px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    position: sticky; top: 0; z-index: 50;
  }
  .user-avatar {
    width: 38px; height: 38px; border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), #6b8fff);
    display: flex; align-items: center; justify-content: center;
    color: white; font-size: 16px; font-weight: 800;
    flex-shrink: 0;
  }
  .user-info { flex: 1; min-width: 0; }
  .user-name { font-size: 14px; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .user-class { font-size: 10px; color: var(--text-light); font-weight: 700; }
  .alt-display {
    display: flex; align-items: center; gap: 4px;
    background: linear-gradient(135deg, #fff8e1, #fff3c4);
    padding: 6px 14px; border-radius: 20px;
    font-family: 'Fredoka', sans-serif; font-size: 15px; font-weight: 700;
    color: #e6a000;
    box-shadow: 0 1px 4px rgba(255,179,0,0.2);
  }
  .alt-display .alt-icon { font-size: 14px; }
  .logout-btn {
    border: none; background: #f5f5f5; cursor: pointer;
    padding: 8px 12px; border-radius: 10px;
    font-family: inherit; font-size: 11px; font-weight: 700;
    color: var(--text-light); transition: all 0.2s;
  }
  .logout-btn:hover { background: #eee; color: var(--text); }

  /* === Tab Bar (bottom) === */
  .tab-bar {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 50;
    background: white; display: flex;
    box-shadow: 0 -2px 12px rgba(0,0,0,0.06);
    border-top: 1px solid #f0f0f0;
  }
  .tab-item {
    flex: 1; display: flex; flex-direction: column; align-items: center;
    padding: 8px 0 10px; border: none; background: none;
    font-family: inherit; font-size: 10px; font-weight: 700;
    color: var(--text-light); cursor: pointer; transition: all 0.2s;
    gap: 2px;
  }
  .tab-item .tab-icon { font-size: 20px; }
  .tab-item.active { color: var(--primary); }
  .tab-item.active .tab-icon { transform: scale(1.1); }

  /* === Tab Content === */
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* === Home Tab === */
  .home-banner {
    margin: 16px 16px 12px; padding: 20px;
    background: linear-gradient(135deg, var(--primary), #6b8fff, #8b9fff);
    border-radius: 18px; color: white; position: relative; overflow: hidden;
  }
  .home-banner::after {
    content: ''; position: absolute; top: -30px; right: -30px;
    width: 120px; height: 120px; border-radius: 50%;
    background: rgba(255,255,255,0.1);
  }
  .home-banner h2 { font-size: 18px; font-weight: 800; margin-bottom: 4px; }
  .home-banner p { font-size: 12px; opacity: 0.85; }
  .section-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 18px 10px;
  }
  .section-header h3 { font-size: 16px; font-weight: 800; }
  .section-header .badge {
    font-size: 10px; font-weight: 700; padding: 3px 10px;
    border-radius: 10px; background: var(--accent); color: white;
  }

  /* === Game Grid === */
  .game-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 12px; padding: 0 16px 20px;
  }
  .game-card {
    background: white; border-radius: var(--radius); overflow: hidden;
    box-shadow: var(--shadow); cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    animation: cardIn 0.35s ease both;
    position: relative;
  }
  .game-card:hover { transform: translateY(-3px); box-shadow: 0 6px 24px rgba(0,0,0,0.12); }
  .game-card:active { transform: scale(0.97); }
  @keyframes cardIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  .card-top {
    height: 6px; width: 100%;
  }
  .card-emoji {
    display: flex; align-items: center; justify-content: center;
    padding: 16px 0 8px; font-size: 40px;
  }
  .card-info { padding: 0 12px 12px; text-align: center; }
  .card-name { font-size: 13px; font-weight: 800; margin-bottom: 4px; line-height: 1.3; }
  .card-cat {
    display: inline-block; font-size: 9px; font-weight: 700;
    padding: 2px 8px; border-radius: 6px; margin-bottom: 6px;
  }
  .card-alt {
    font-family: 'Fredoka', sans-serif; font-size: 11px;
    color: var(--yellow); font-weight: 600;
    margin-bottom: 6px;
  }
  .card-play-btn {
    width: 100%; padding: 8px; border: none; border-radius: 10px;
    font-family: inherit; font-size: 11px; font-weight: 800;
    color: white; cursor: pointer;
  }
  .game-card.coming-soon { opacity: 0.45; pointer-events: none; }
  .game-card.coming-soon .card-play-btn { background: #ccc !important; }
  .game-card .badge-new {
    position: absolute; top: 10px; right: 8px;
    font-size: 9px; font-weight: 700; padding: 2px 8px;
    border-radius: 6px; background: var(--accent); color: white;
  }
  .game-card .badge-soon {
    position: absolute; top: 10px; right: 8px;
    font-size: 9px; font-weight: 700; padding: 2px 8px;
    border-radius: 6px; background: #aaa; color: white;
  }

  /* === Ranking Tab === */
  .ranking-header {
    text-align: center; padding: 24px 16px 16px;
  }
  .ranking-header h2 { font-size: 20px; font-weight: 800; }
  .ranking-header p { font-size: 12px; color: var(--text-light); }
  .ranking-filters {
    display: flex; gap: 6px; padding: 0 16px 12px;
    overflow-x: auto; -webkit-mask-image: linear-gradient(to right, black 92%, transparent);
  }
  .ranking-filters::-webkit-scrollbar { display: none; }
  .rank-filter-btn {
    flex-shrink: 0; padding: 7px 14px; border-radius: 20px;
    border: 2px solid #e8ecf4; background: white;
    font-family: inherit; font-size: 11px; font-weight: 700;
    color: var(--text-light); cursor: pointer; transition: all 0.2s;
  }
  .rank-filter-btn.active {
    border-color: var(--primary); background: var(--primary); color: white;
  }
  .ranking-list { padding: 0 16px 20px; }
  .rank-item {
    display: flex; align-items: center; gap: 12px;
    background: white; border-radius: 14px; padding: 12px 16px;
    margin-bottom: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.03);
  }
  .rank-num {
    font-family: 'Fredoka', sans-serif; font-size: 18px; font-weight: 700;
    width: 32px; text-align: center; flex-shrink: 0;
  }
  .rank-num.gold { color: #FFB300; }
  .rank-num.silver { color: #90A4AE; }
  .rank-num.bronze { color: #A1887F; }
  .rank-avatar {
    width: 36px; height: 36px; border-radius: 50%;
    background: linear-gradient(135deg, #e8f0fe, #d0dcf8);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 800; color: var(--primary);
    flex-shrink: 0;
  }
  .rank-info { flex: 1; min-width: 0; }
  .rank-name { font-size: 13px; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .rank-class { font-size: 10px; color: var(--text-light); }
  .rank-score {
    font-family: 'Fredoka', sans-serif; font-size: 18px; font-weight: 700;
    color: var(--primary); flex-shrink: 0;
  }
  .ranking-empty {
    text-align: center; padding: 40px; color: var(--text-light);
    font-size: 13px; font-weight: 700;
  }
  .ranking-empty .empty-icon { font-size: 40px; margin-bottom: 8px; opacity: 0.4; }

  /* === ALT History Tab === */
  .history-header {
    text-align: center; padding: 24px 16px 16px;
  }
  .history-header h2 { font-size: 20px; font-weight: 800; }
  .history-total-alt {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    margin: 8px 0 16px;
    font-family: 'Fredoka', sans-serif; font-size: 32px; font-weight: 700;
    color: #e6a000;
  }
  .history-list { padding: 0 16px 20px; }
  .history-item {
    display: flex; align-items: center; gap: 12px;
    background: white; border-radius: 14px; padding: 12px 16px;
    margin-bottom: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.03);
  }
  .hist-emoji { font-size: 24px; flex-shrink: 0; }
  .hist-info { flex: 1; min-width: 0; }
  .hist-title { font-size: 13px; font-weight: 800; }
  .hist-time { font-size: 10px; color: var(--text-light); }
  .hist-alt {
    font-family: 'Fredoka', sans-serif; font-size: 16px; font-weight: 700;
    color: var(--green); flex-shrink: 0;
  }

  /* === Game Embed View === */
  .game-embed-view {
    display: none; position: fixed; inset: 0; z-index: 100;
    background: white; flex-direction: column;
  }
  .game-embed-view.active { display: flex; }
  .embed-header {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 16px; background: white;
    border-bottom: 1px solid #f0f0f0; flex-shrink: 0;
  }
  .embed-back {
    border: none; background: #f0f2f5; cursor: pointer;
    padding: 8px 14px; border-radius: 10px;
    font-family: inherit; font-size: 12px; font-weight: 700;
    color: var(--text); transition: all 0.2s;
  }
  .embed-back:hover { background: #e4e8ee; }
  .embed-title { font-size: 14px; font-weight: 800; flex: 1; display: flex; align-items: center; gap: 6px; }
  .embed-fullscreen {
    border: none; background: #f0f2f5; cursor: pointer;
    padding: 8px 12px; border-radius: 10px; font-size: 16px;
  }
  .embed-iframe-wrap { flex: 1; position: relative; }
  .embed-iframe-wrap iframe { width: 100%; height: 100%; border: none; }
  .embed-loading {
    position: absolute; inset: 0; display: flex;
    flex-direction: column; align-items: center; justify-content: center;
    background: var(--bg); z-index: 5; transition: opacity 0.3s;
  }
  .embed-loading.hidden { opacity: 0; pointer-events: none; }
  .embed-loading .spinner { font-size: 48px; animation: spin 1.5s ease-in-out infinite; }
  @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  .embed-loading .loading-text { font-size: 13px; font-weight: 700; color: var(--text-light); margin-top: 10px; }

  /* === Toast === */
  .toast {
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
    background: var(--text); color: white; padding: 12px 24px; border-radius: 14px;
    font-size: 13px; font-weight: 700; z-index: 999;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    animation: toastIn 0.3s ease, toastOut 0.3s ease 2s forwards;
  }
  @keyframes toastIn { from{opacity:0;transform:translateX(-50%) translateY(12px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
  @keyframes toastOut { to{opacity:0;transform:translateX(-50%) translateY(12px)} }

  /* === ALT Popup === */
  .alt-popup {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
    background: white; border-radius: 24px; padding: 28px 32px;
    text-align: center; z-index: 200;
    box-shadow: 0 16px 48px rgba(0,0,0,0.2);
    animation: popIn 0.3s ease;
  }
  .alt-popup-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.3);
    z-index: 199; animation: fadeIn 0.2s ease;
  }
  @keyframes popIn { from{opacity:0;transform:translate(-50%,-50%) scale(0.9)} to{opacity:1;transform:translate(-50%,-50%) scale(1)} }
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  .alt-popup .alt-earned {
    font-family: 'Fredoka', sans-serif; font-size: 48px; font-weight: 700;
    color: var(--green); margin: 12px 0;
  }
  .alt-popup .alt-label { font-size: 14px; font-weight: 800; color: var(--text); }
  .alt-popup .alt-close {
    margin-top: 16px; padding: 10px 32px; border-radius: 12px;
    border: none; background: var(--primary); color: white;
    font-family: inherit; font-size: 14px; font-weight: 800;
    cursor: pointer;
  }

  /* Hidden helper */
  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- ===== Login Screen ===== -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="login-logo">üå≤</div>
    <div class="login-title">TRAIL Game Pro 3</div>
    <div class="login-subtitle">Êé¢Á©∂ÊïôÂÆ§ TRAIL „Ç≤„Éº„É†„Éù„Éº„Çø„É´</div>

    <div class="login-section-label">„Å´„ÇÖ„ÅÜ„Åó„Å§ „ÇØ„É©„Çπ„Çí„Åà„Çâ„Çì„Åß„Å≠</div>
    <div class="class-grid" id="classGrid"></div>

    <div class="login-section-label">„Å™„Åæ„Åà</div>
    <input class="login-input" id="nameInput" type="text" placeholder="„Å™„Åæ„Åà„ÇíÂÖ•Âäõ" maxlength="20" autocomplete="off">

    <button class="login-submit" id="loginBtn" disabled>„Å´„ÇÖ„ÅÜ„Åó„Å§„Åô„Çã</button>
    <div class="login-error hidden" id="loginError"></div>

    <button class="login-guest" id="guestBtn">„Å™„Åæ„Åà„Å™„Åó„Åß„ÅÇ„Åù„Å∂</button>
  </div>
</div>

<!-- ===== Main App ===== -->
<div class="app" id="mainApp">
  <!-- Top Header -->
  <div class="top-header">
    <div class="user-avatar" id="userAvatar"></div>
    <div class="user-info">
      <div class="user-name" id="userName"></div>
      <div class="user-class" id="userClass"></div>
    </div>
    <div class="alt-display">
      <span class="alt-icon">ALT</span>
      <span id="altCount">0</span>
    </div>
    <button class="logout-btn" id="logoutBtn">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
  </div>

  <!-- Tab Contents -->
  <div class="tab-content active" id="tabHome">
    <div class="home-banner">
      <h2 id="bannerGreeting">„Çà„ÅÜ„Åì„ÅùÔºÅ</h2>
      <p>„Ç≤„Éº„É†„Åß„ÅÇ„Åù„Çì„ÅßALT„Çí„Åü„ÇÅ„Çà„ÅÜÔºÅ</p>
    </div>

    <div class="section-header">
      <h3>GAMES</h3>
      <span class="badge" id="gameCountBadge">0</span>
    </div>
    <div class="game-grid" id="gameGrid"></div>

    <div class="section-header hidden" id="comingSoonHeader">
      <h3>COMING SOON</h3>
    </div>
    <div class="game-grid" id="comingSoonGrid"></div>
  </div>

  <div class="tab-content" id="tabRanking">
    <div class="ranking-header">
      <h2>„É©„É≥„Ç≠„É≥„Ç∞</h2>
      <p>„Åø„Çì„Å™„ÅÆ„Éô„Çπ„Éà„Çπ„Ç≥„Ç¢</p>
    </div>
    <div class="ranking-filters" id="rankFilters"></div>
    <div class="ranking-list" id="rankingList"></div>
  </div>

  <div class="tab-content" id="tabGames">
    <div class="section-header">
      <h3>„Åô„Åπ„Å¶„ÅÆ„Ç≤„Éº„É†</h3>
    </div>
    <div class="ranking-filters" id="catFilters"></div>
    <div class="game-grid" id="allGamesGrid"></div>
  </div>

  <div class="tab-content" id="tabHistory">
    <div class="history-header">
      <h2>ALT „Çä„Çå„Åç</h2>
      <div class="history-total-alt">
        <span>ALT</span>
        <span id="historyTotalAlt">0</span>
      </div>
    </div>
    <div class="history-list" id="historyList"></div>
  </div>

  <!-- Bottom Tab Bar -->
  <div class="tab-bar">
    <button class="tab-item active" data-tab="tabHome">
      <span class="tab-icon">üè†</span> HOME
    </button>
    <button class="tab-item" data-tab="tabRanking">
      <span class="tab-icon">üèÜ</span> „É©„É≥„Ç≠„É≥„Ç∞
    </button>
    <button class="tab-item" data-tab="tabGames">
      <span class="tab-icon">üéÆ</span> „Ç≤„Éº„É†
    </button>
    <button class="tab-item" data-tab="tabHistory">
      <span class="tab-icon">üìã</span> ALTÂ±•Ê≠¥
    </button>
  </div>
</div>

<!-- ===== Game Embed ===== -->
<div class="game-embed-view" id="gameEmbed">
  <div class="embed-header">
    <button class="embed-back" id="embedBack">‚Üê „ÇÇ„Å©„Çã</button>
    <div class="embed-title">
      <span id="embedEmoji"></span>
      <span id="embedTitle"></span>
    </div>
    <button class="embed-fullscreen" id="embedFullscreen" title="„Éï„É´„Çπ„ÇØ„É™„Éº„É≥">‚õ∂</button>
  </div>
  <div class="embed-iframe-wrap">
    <div class="embed-loading" id="embedLoading">
      <div class="spinner">üå≤</div>
      <div class="loading-text">„Çà„Åø„Åì„Åø‰∏≠...</div>
    </div>
    <iframe id="embedIframe" sandbox="allow-scripts allow-same-origin allow-popups" title="„Ç≤„Éº„É†"></iframe>
  </div>
</div>

<script src="shared/game-registry.js"></script>
<script src="shared/trail-api.js"></script>
<script>
// =============================================================
// TRAIL Game Pro 3 - Main Application
// =============================================================

var games = TRAIL_GAMES;
var categories = TRAIL_CATEGORIES;
var classes = TRAIL_CLASSES;
var currentUser = null;
var currentTab = 'tabHome';
var currentGame = null;
var rankingGameFilter = null;
var catFilter = 'all';

// =====================
// GAS URL Configuration
// =====================
// Uncomment and set your GAS deployment URL:
// TrailAPI.configure('https://script.google.com/macros/s/YOUR_ID/exec');

// =====================
// Init
// =====================
(function init() {
  renderClassGrid();
  setupLoginHandlers();
  setupTabBar();
  setupEmbedHandlers();
  listenForGameMessages();

  // Auto-login from session
  var saved = TrailAPI.currentUser();
  if (saved && saved.name) {
    enterApp(saved);
  }
})();

// =====================
// Login
// =====================
var selectedClass = null;

function renderClassGrid() {
  var grid = document.getElementById('classGrid');
  grid.innerHTML = '';
  classes.forEach(function(cls) {
    var btn = document.createElement('button');
    btn.className = 'class-btn';
    btn.textContent = cls.name;
    btn.dataset.id = cls.id;
    btn.addEventListener('click', function() {
      document.querySelectorAll('.class-btn').forEach(function(b) { b.classList.remove('selected'); });
      btn.classList.add('selected');
      selectedClass = cls;
      checkLoginReady();
    });
    grid.appendChild(btn);
  });
}

function checkLoginReady() {
  var name = document.getElementById('nameInput').value.trim();
  document.getElementById('loginBtn').disabled = !(selectedClass && name.length > 0);
}

function setupLoginHandlers() {
  document.getElementById('nameInput').addEventListener('input', checkLoginReady);

  document.getElementById('loginBtn').addEventListener('click', function() {
    var name = document.getElementById('nameInput').value.trim();
    if (!selectedClass || !name) return;
    var btn = document.getElementById('loginBtn');
    var errEl = document.getElementById('loginError');
    btn.disabled = true;
    btn.textContent = '„É≠„Ç∞„Ç§„É≥‰∏≠...';
    errEl.classList.add('hidden');

    if (TrailAPI.isConfigured()) {
      TrailAPI.login(name, selectedClass.name).then(function(user) {
        enterApp(user);
      }).catch(function(err) {
        if (err.code === 'NOT_REGISTERED') {
          showNotRegisteredPopup();
        } else {
          errEl.textContent = '„É≠„Ç∞„Ç§„É≥„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÇÇ„ÅÜ„ÅÑ„Å°„Å©„Åü„ÇÅ„Åó„Å¶„Å≠„ÄÇ';
          errEl.classList.remove('hidden');
        }
        btn.textContent = '„Å´„ÇÖ„ÅÜ„Åó„Å§„Åô„Çã';
        btn.disabled = false;
      });
    } else {
      // Local/demo mode ‚Äî allow without server
      var user = { userId: 'local_' + Date.now(), name: name, className: selectedClass.name, totalAlt: 0 };
      try {
        localStorage.setItem('trail:session', JSON.stringify(user));
        sessionStorage.setItem('trail:session', JSON.stringify(user));
      } catch(e) {}
      enterApp(user);
    }
  });

  document.getElementById('guestBtn').addEventListener('click', function() {
    enterApp({ userId: 'guest', name: '„Ç≤„Çπ„Éà', className: '', totalAlt: 0 });
  });

  document.getElementById('logoutBtn').addEventListener('click', function() {
    TrailAPI.logout();
    currentUser = null;
    document.getElementById('mainApp').classList.remove('active');
    document.getElementById('loginScreen').style.display = '';
    document.getElementById('loginBtn').textContent = '„Å´„ÇÖ„ÅÜ„Åó„Å§„Åô„Çã';
    document.getElementById('loginBtn').disabled = true;
    document.getElementById('nameInput').value = '';
    selectedClass = null;
    document.querySelectorAll('.class-btn').forEach(function(b) { b.classList.remove('selected'); });
  });
}

function enterApp(user) {
  currentUser = user;
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainApp').classList.add('active');

  // Set user info
  document.getElementById('userAvatar').textContent = (user.name || '?')[0];
  document.getElementById('userName').textContent = user.name;
  document.getElementById('userClass').textContent = user.className || '';
  document.getElementById('altCount').textContent = user.totalAlt || 0;
  document.getElementById('bannerGreeting').textContent = user.name + '„Åï„Çì„ÄÅ„Çà„ÅÜ„Åì„ÅùÔºÅ';

  renderAllViews();

  // Auto-launch game from URL parameter (?game=silhouette-quiz)
  var urlGame = new URLSearchParams(window.location.search).get('game');
  if (urlGame) {
    launchGame(urlGame);
  }
}

// =====================
// Tab Bar
// =====================
function setupTabBar() {
  document.querySelectorAll('.tab-item').forEach(function(tab) {
    tab.addEventListener('click', function() {
      switchTab(tab.dataset.tab);
    });
  });
}

function switchTab(tabId) {
  currentTab = tabId;
  document.querySelectorAll('.tab-item').forEach(function(t) {
    t.classList.toggle('active', t.dataset.tab === tabId);
  });
  document.querySelectorAll('.tab-content').forEach(function(c) {
    c.classList.toggle('active', c.id === tabId);
  });

  if (tabId === 'tabRanking') renderRankings();
  if (tabId === 'tabHistory') renderHistory();
  if (tabId === 'tabGames') renderAllGames();
}

// =====================
// Render Views
// =====================
function renderAllViews() {
  renderHomeGames();
  renderRankingFilters();
  renderCatFilters();
}

function renderHomeGames() {
  var grid = document.getElementById('gameGrid');
  var comingGrid = document.getElementById('comingSoonGrid');
  var comingHeader = document.getElementById('comingSoonHeader');
  grid.innerHTML = '';
  comingGrid.innerHTML = '';

  var playable = games.filter(function(g) { return !g.comingSoon && g.url; });
  var coming = games.filter(function(g) { return g.comingSoon; });

  document.getElementById('gameCountBadge').textContent = playable.length;

  playable.forEach(function(game, idx) {
    grid.appendChild(createGameCard(game, idx));
  });

  if (coming.length > 0) {
    comingHeader.classList.remove('hidden');
    coming.forEach(function(game, idx) {
      comingGrid.appendChild(createGameCard(game, idx));
    });
  } else {
    comingHeader.classList.add('hidden');
  }
}

function createGameCard(game, idx) {
  var card = document.createElement('div');
  card.className = 'game-card' + (game.comingSoon ? ' coming-soon' : '');
  card.style.animationDelay = (idx * 0.04) + 's';

  var catLabel = game.tags[0] || '';
  var catColor = game.color || '#4a7cff';

  var badge = '';
  if (game.isNew && !game.comingSoon) badge = '<div class="badge-new">NEW</div>';
  else if (game.comingSoon) badge = '<div class="badge-soon">Ê∫ñÂÇô‰∏≠</div>';

  card.innerHTML =
    badge +
    '<div class="card-top" style="background:' + catColor + '"></div>' +
    '<div class="card-emoji">' + game.emoji + '</div>' +
    '<div class="card-info">' +
      '<div class="card-name">' + game.title + '</div>' +
      '<div class="card-cat" style="background:' + catColor + '18;color:' + catColor + '">' + catLabel + '</div>' +
      '<div class="card-alt">ALT +' + (game.altReward || 10) + '</div>' +
      '<button class="card-play-btn" style="background:' + catColor + '">' +
        (game.comingSoon ? 'Ê∫ñÂÇô‰∏≠' : '„Çø„ÉÉ„Éó„Åß„Éó„É¨„Ç§') +
      '</button>' +
    '</div>';

  if (!game.comingSoon) {
    card.addEventListener('click', function() { launchGame(game.id); });
  }
  return card;
}

// =====================
// Game Launch
// =====================
function launchGame(gameId) {
  var game = games.find(function(g) { return g.id === gameId; });
  if (!game || !game.url) return;

  if (game.external) {
    window.open(game.url, '_blank');
    return;
  }

  currentGame = game;
  document.getElementById('embedEmoji').textContent = game.emoji;
  document.getElementById('embedTitle').textContent = game.title;

  var iframe = document.getElementById('embedIframe');
  var loading = document.getElementById('embedLoading');
  loading.classList.remove('hidden');
  iframe.onload = function() { loading.classList.add('hidden'); };
  iframe.src = game.url;

  document.getElementById('gameEmbed').classList.add('active');

  // Update URL with game parameter
  var url = new URL(window.location);
  url.searchParams.set('game', gameId);
  history.replaceState(null, '', url);
}

function closeEmbed() {
  document.getElementById('gameEmbed').classList.remove('active');
  var iframe = document.getElementById('embedIframe');
  iframe.src = 'about:blank';
  currentGame = null;

  // Remove game parameter from URL
  var url = new URL(window.location);
  url.searchParams.delete('game');
  history.replaceState(null, '', url);
}

function setupEmbedHandlers() {
  document.getElementById('embedBack').addEventListener('click', closeEmbed);
  document.getElementById('embedFullscreen').addEventListener('click', function() {
    var el = document.getElementById('gameEmbed');
    if (document.fullscreenElement) document.exitFullscreen();
    else el.requestFullscreen().catch(function(){});
  });
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && currentGame) closeEmbed();
  });
}

// =====================
// postMessage from games
// =====================
function listenForGameMessages() {
  window.addEventListener('message', function(e) {
    var msg = e.data;
    if (!msg || typeof msg.type !== 'string') return;

    if (msg.type === 'trail:gameOver' && msg.gameId && msg.data) {
      handleGameOver(msg.gameId, msg.data);
    }
    if (msg.type === 'trail:navigate') {
      if (msg.target === 'home') closeEmbed();
    }
  });
}

function handleGameOver(gameId, data) {
  var score = data.score || 0;
  var correct = data.correct || 0;
  var total = data.total || 0;

  if (TrailAPI.isConfigured() && currentUser && currentUser.userId !== 'guest') {
    TrailAPI.saveScore(gameId, score, correct, total).then(function(res) {
      if (res && !res.error && !res.guest) {
        currentUser.totalAlt = res.totalAlt;
        document.getElementById('altCount').textContent = res.totalAlt;
        showAltPopup(res.altEarned);
      }
    });
  } else {
    // Local mode ALT
    var altEarned = calcLocalAlt(score, correct, total);
    var localAlt = (currentUser.totalAlt || 0) + altEarned;
    currentUser.totalAlt = localAlt;
    document.getElementById('altCount').textContent = localAlt;
    // Save locally
    saveLocalHistory(gameId, score, correct, total, altEarned);
    showAltPopup(altEarned);
  }
}

function calcLocalAlt(score, correct, total) {
  var alt = 10;
  if (total > 0) {
    var ratio = correct / total;
    if (ratio >= 1.0) alt += 30;
    else if (ratio >= 0.8) alt += 20;
    else if (ratio >= 0.5) alt += 10;
  }
  alt += Math.floor(score / 100) * 5;
  return alt;
}

function saveLocalHistory(gameId, score, correct, total, altEarned) {
  try {
    var key = 'trail:scores';
    var h = JSON.parse(localStorage.getItem(key) || '[]');
    h.unshift({ gameId: gameId, score: score, correct: correct, total: total, altEarned: altEarned, timestamp: Date.now() });
    if (h.length > 100) h = h.slice(0, 100);
    localStorage.setItem(key, JSON.stringify(h));
  } catch(e) {}
}

function showAltPopup(earned) {
  // Remove existing
  var old = document.querySelector('.alt-popup');
  var oldOv = document.querySelector('.alt-popup-overlay');
  if (old) old.remove();
  if (oldOv) oldOv.remove();

  var overlay = document.createElement('div');
  overlay.className = 'alt-popup-overlay';

  var popup = document.createElement('div');
  popup.className = 'alt-popup';
  popup.innerHTML =
    '<div style="font-size:48px">üéâ</div>' +
    '<div class="alt-label">ALT „Ç≤„ÉÉ„ÉàÔºÅ</div>' +
    '<div class="alt-earned">+' + earned + '</div>' +
    '<button class="alt-close">OK</button>';

  document.body.appendChild(overlay);
  document.body.appendChild(popup);

  var close = function() { overlay.remove(); popup.remove(); };
  popup.querySelector('.alt-close').addEventListener('click', close);
  overlay.addEventListener('click', close);
  setTimeout(close, 4000);
}

// =====================
// Rankings
// =====================
function renderRankingFilters() {
  var container = document.getElementById('rankFilters');
  var html = '<button class="rank-filter-btn active" data-game="">üèÜ Á∑èÂêà</button>';
  games.filter(function(g) { return !g.comingSoon && g.url && !g.external; }).forEach(function(g) {
    html += '<button class="rank-filter-btn" data-game="' + g.id + '">' + g.emoji + ' ' + g.title + '</button>';
  });
  container.innerHTML = html;

  container.querySelectorAll('.rank-filter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      container.querySelectorAll('.rank-filter-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      rankingGameFilter = btn.dataset.game || null;
      renderRankings();
    });
  });
}

function renderRankings() {
  var container = document.getElementById('rankingList');

  if (TrailAPI.isConfigured()) {
    container.innerHTML = '<div class="ranking-empty"><div class="empty-icon">‚è≥</div>Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
    TrailAPI.getRankings(rankingGameFilter, 20).then(function(rankings) {
      renderRankingList(container, rankings);
    });
  } else {
    // Local rankings from stored scores
    var localScores = getLocalScores();
    var filtered = rankingGameFilter
      ? localScores.filter(function(s) { return s.gameId === rankingGameFilter; })
      : localScores;
    // Deduplicate: best per game
    var best = {};
    filtered.forEach(function(s) {
      var key = s.gameId;
      if (!best[key] || s.score > best[key].score) best[key] = s;
    });
    var rankings = Object.values(best).sort(function(a,b) { return b.score - a.score; }).slice(0, 20);
    rankings.forEach(function(r, i) {
      r.rank = i + 1;
      r.name = currentUser ? currentUser.name : '„Ç≤„Çπ„Éà';
      r.className = currentUser ? currentUser.className : '';
    });
    renderRankingList(container, rankings);
  }
}

function renderRankingList(container, rankings) {
  if (!rankings || rankings.length === 0) {
    container.innerHTML = '<div class="ranking-empty"><div class="empty-icon">üèÜ</div>„Åæ„Å†„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„Åå„Å™„ÅÑ„Çà„ÄÇ<br>„Ç≤„Éº„É†„Åß„ÅÇ„Åù„Çì„Åß„Åø„Çà„ÅÜÔºÅ</div>';
    return;
  }
  container.innerHTML = rankings.map(function(r) {
    var numClass = r.rank === 1 ? 'gold' : r.rank === 2 ? 'silver' : r.rank === 3 ? 'bronze' : '';
    var medal = r.rank <= 3 ? ['ü•á','ü•à','ü•â'][r.rank-1] : r.rank;
    var game = games.find(function(g) { return g.id === r.gameId; });
    var emoji = game ? game.emoji : 'üéÆ';
    return '<div class="rank-item">' +
      '<div class="rank-num ' + numClass + '">' + medal + '</div>' +
      '<div class="rank-avatar">' + (r.name || '?')[0] + '</div>' +
      '<div class="rank-info"><div class="rank-name">' + (r.name || '???') + '</div><div class="rank-class">' + (r.className || '') + (game ? ' - ' + emoji + game.title : '') + '</div></div>' +
      '<div class="rank-score">' + (r.score || 0) + '</div>' +
    '</div>';
  }).join('');
}

function getLocalScores() {
  try {
    return JSON.parse(localStorage.getItem('trail:scores') || '[]');
  } catch(e) { return []; }
}

// =====================
// All Games Tab
// =====================
function renderCatFilters() {
  var container = document.getElementById('catFilters');
  var html = '';
  categories.forEach(function(cat) {
    html += '<button class="rank-filter-btn' + (cat.id === 'all' ? ' active' : '') + '" data-cat="' + cat.id + '">' + cat.emoji + ' ' + cat.label + '</button>';
  });
  container.innerHTML = html;

  container.querySelectorAll('.rank-filter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      container.querySelectorAll('.rank-filter-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      catFilter = btn.dataset.cat;
      renderAllGames();
    });
  });
}

function renderAllGames() {
  var grid = document.getElementById('allGamesGrid');
  grid.innerHTML = '';
  var filtered = catFilter === 'all' ? games : games.filter(function(g) { return g.category === catFilter; });
  filtered.forEach(function(game, idx) {
    grid.appendChild(createGameCard(game, idx));
  });
}

// =====================
// ALT History
// =====================
function renderHistory() {
  var totalEl = document.getElementById('historyTotalAlt');
  var listEl = document.getElementById('historyList');
  totalEl.textContent = currentUser ? (currentUser.totalAlt || 0) : 0;

  if (TrailAPI.isConfigured() && currentUser && currentUser.userId !== 'guest') {
    listEl.innerHTML = '<div class="ranking-empty"><div class="empty-icon">‚è≥</div>Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
    TrailAPI.getHistory(30).then(function(history) {
      renderHistoryList(listEl, history);
    });
  } else {
    var local = getLocalScores();
    renderHistoryList(listEl, local);
  }
}

function renderHistoryList(container, history) {
  if (!history || history.length === 0) {
    container.innerHTML = '<div class="ranking-empty"><div class="empty-icon">üìã</div>„Åæ„Å†Ë®òÈå≤„Åå„Å™„ÅÑ„Çà„ÄÇ<br>„Ç≤„Éº„É†„Åß„ÅÇ„Åù„Çì„ÅßALT„Çí„Ç≤„ÉÉ„Éà„Åó„Çà„ÅÜÔºÅ</div>';
    return;
  }
  container.innerHTML = history.map(function(h) {
    var game = games.find(function(g) { return g.id === h.gameId; });
    var emoji = game ? game.emoji : 'üéÆ';
    var title = game ? game.title : h.gameId;
    var time = formatTime(h.timestamp);
    var alt = h.altEarned || 0;
    return '<div class="history-item">' +
      '<span class="hist-emoji">' + emoji + '</span>' +
      '<div class="hist-info"><div class="hist-title">' + title + '</div><div class="hist-time">' + time + ' - „Çπ„Ç≥„Ç¢: ' + (h.score || 0) + '</div></div>' +
      '<div class="hist-alt">+' + alt + '</div>' +
    '</div>';
  }).join('');
}

// =====================
// Utilities
// =====================
function formatTime(ts) {
  if (!ts) return '';
  var d = new Date(typeof ts === 'string' ? ts : ts);
  var now = new Date();
  var diff = Math.floor((now - d) / 60000);
  if (diff < 1) return '„Åü„Å£„Åü„ÅÑ„Åæ';
  if (diff < 60) return diff + 'ÂàÜ„Åæ„Åà';
  var hr = Math.floor(diff / 60);
  if (hr < 24) return hr + 'ÊôÇÈñì„Åæ„Åà';
  var day = Math.floor(hr / 24);
  if (day < 7) return day + 'Êó•„Åæ„Åà';
  return (d.getMonth() + 1) + '/' + d.getDate();
}

function showToast(msg) {
  var old = document.querySelector('.toast');
  if (old) old.remove();
  var t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(function() { t.remove(); }, 2500);
}

// =====================
// Not Registered Popup
// =====================
function showNotRegisteredPopup() {
  var overlay = document.getElementById('notRegisteredPopup');
  overlay.classList.add('active');
}
function closeNotRegisteredPopup() {
  document.getElementById('notRegisteredPopup').classList.remove('active');
}
</script>

<!-- ===== Not Registered Popup ===== -->
<div class="popup-overlay" id="notRegisteredPopup">
  <div class="popup-box">
    <div class="popup-emoji">üò¢</div>
    <div class="popup-title">ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>
    <div class="popup-message">
      „Åì„ÅÆ„Å™„Åæ„Åà„ÅØ „Åæ„Å†ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Çà„ÄÇ<br>
      LINE„Åß <strong>„ÄåÁôªÈå≤Â∏åÊúõ„Äç</strong> „Å®„É°„ÉÉ„Çª„Éº„Ç∏„Åó„Å¶„Å≠ÔºÅ
    </div>
    <button class="popup-close-btn" onclick="closeNotRegisteredPopup()">„Å®„Åò„Çã</button>
  </div>
</div>

</body>
</html>
