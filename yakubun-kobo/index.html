<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç´„åˆ†å·¥æˆ¿ ðŸ”¨</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body, #root { width: 100%; height: 100%; overflow: hidden; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useCallback, useRef, useEffect } = React;

const HAND_MAX = 8;
const DECK_SIZE = 36;
const TURN_TIME = 60;
function shuffle(a) { const b = [...a]; for (let i = b.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [b[i], b[j]] = [b[j], b[i]]; } return b; }
function rollD6() { return Math.floor(Math.random() * 6) + 1; }
function createDeck() {
  const c = [];
  for (let n = 1; n <= 9; n++) { c.push({ type: "number", value: n }); c.push({ type: "number", value: n }); c.push({ type: "number", value: n }); }
  for (let i = 0; i < 5; i++) c.push({ type: "multiply" });
  for (let i = 0; i < 2; i++) c.push({ type: "wild" });
  return shuffle(c);
}
function cardLabel(c, wv) {
  if (c.type === "number") return String(c.value);
  if (c.type === "multiply") return "\u00d7";
  if (c.type === "add") return "\uff0b";
  if (c.type === "subtract") return "\u2212";
  if (c.type === "divide") return "\u00f7";
  if (c.type === "wild") return wv ? "\u2605" + wv : "\u2605";
  return "?";
}
const SPECIALS = [
  { id: "redraw", emoji: "\u{1f504}", name: "\u5f15\u304d\u76f4\u3057" },
  { id: "reroll", emoji: "\u{1f3b2}", name: "\u632f\u308a\u76f4\u3057" },
  { id: "pick", emoji: "\u{1f522}", name: "\u597d\u304d\u306a\u6570\u5b57" },
  { id: "pickop", emoji: "\u2728", name: "\u597d\u304d\u306a\u6f14\u7b97" },
];

function YakubunKoubou() {
  const [phase, setPhase] = useState("title");
  const [mode, setMode] = useState("normal");
  const [deck, setDeck] = useState([]);
  const [hand, setHand] = useState([]);
  const [diceNum, setDiceNum] = useState(null);
  const [diceDen, setDiceDen] = useState(null);
  const [numZone, setNumZone] = useState([]);
  const [denZone, setDenZone] = useState([]);
  const [msg, setMsg] = useState("");
  const [round, setRound] = useState(0);
  const [score, setScore] = useState(0);
  const [totalUsed, setTotalUsed] = useState(0);
  const [rolling, setRolling] = useState(false);
  const [happeningMsg, setHappeningMsg] = useState("");
  const [wildMap, setWildMap] = useState({});
  const [wildPicker, setWildPicker] = useState(null);
  const [dragging, setDragging] = useState(null);
  const [dragPos, setDragPos] = useState({ x: 0, y: 0 });
  const [dragOff, setDragOff] = useState({ x: 0, y: 0 });
  const [dragFrom, setDragFrom] = useState(null);
  const [numHov, setNumHov] = useState(false);
  const [denHov, setDenHov] = useState(false);
  const [combo, setCombo] = useState(0);
  const [maxCombo, setMaxCombo] = useState(0);
  const [reorderTarget, setReorderTarget] = useState(null);
  const [scorePopup, setScorePopup] = useState(null);
  const [specials, setSpecials] = useState({ redraw: 1, reroll: 1, pick: 1, pickop: 1 });
  const [pickPicker, setPickPicker] = useState(false);
  const [opPicker, setOpPicker] = useState(false);
  const [timer, setTimer] = useState(TURN_TIME);
  const [rollDisplay, setRollDisplay] = useState({ n: null, d: null });
  const timerRef = useRef(null);
  const rollAnimRef = useRef(null);
  const numRef = useRef(null);
  const denRef = useRef(null);
  const numCardRefs = useRef({});
  const denCardRefs = useRef({});
  const uidRef = useRef(0);
  const mkUid = () => ++uidRef.current;

  useEffect(() => {
    if (phase === "playing" && mode === "normal") {
      timerRef.current = setInterval(() => setTimer(t => { if (t <= 1) { clearInterval(timerRef.current); return 0; } return t - 1; }), 1000);
      return () => clearInterval(timerRef.current);
    } else { clearInterval(timerRef.current); }
  }, [phase, mode]);

  useEffect(() => {
    if (timer === 0 && phase === "playing" && mode === "normal") {
      const all = [...hand, ...numZone, ...denZone];
      setNumZone([]); setDenZone([]); setWildMap({}); setCombo(0); setMsg("\u23f0 \u30bf\u30a4\u30e0\u30aa\u30fc\u30d0\u30fc\uff01"); setRound(r => r + 1);
      if (deck.length <= 0) { setTimeout(() => { setPhase("gameOver"); setMsg("\u5de5\u623f\u9589\u5e97\uff01"); }, 800); }
      else { setPhase("autoRolling"); setTimeout(() => doRoll(all, deck), 1000); }
    }
  }, [timer]);

  useEffect(() => {
    if (phase === "title") return;
    const prevent = (e) => { if (e.target.closest?.("[data-scrollable]")) return; e.preventDefault(); };
    document.addEventListener("touchmove", prevent, { passive: false });
    const s = document.body.style;
    const p = { overflow: s.overflow, position: s.position, width: s.width, height: s.height };
    s.overflow = "hidden"; s.position = "fixed"; s.width = "100%"; s.height = "100%";
    return () => { document.removeEventListener("touchmove", prevent); s.overflow = p.overflow; s.position = p.position; s.width = p.width; s.height = p.height; };
  }, [phase, dragging]);

  const startGame = useCallback((m) => {
    uidRef.current = 0;
    const d = createDeck().map(c => ({ ...c, uid: mkUid() }));
    const h = d.splice(0, HAND_MAX);
    setDeck(d); setHand(h); setMode(m);
    setDiceNum(null); setDiceDen(null); setNumZone([]); setDenZone([]);
    setMsg("\u30b5\u30a4\u30b3\u30ed\u3092\u632f\u308d\u3046\uff01"); setRound(1); setScore(0); setTotalUsed(0); setCombo(0); setMaxCombo(0);
    setPhase("rolling"); setWildMap({}); setWildPicker(null);
    setReorderTarget(null); setScorePopup(null); setPickPicker(false); setOpPicker(false);
    setSpecials({ redraw: 1, reroll: 1, pick: 1, pickop: 1 }); setTimer(TURN_TIME);
  }, []);

  const hit = (r, x, y) => r && x >= r.left && x <= r.right && y >= r.top && y <= r.bottom;
  const getXY = (e) => { if (e.touches?.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY }; if (e.changedTouches?.length > 0) return { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY }; return { x: e.clientX, y: e.clientY }; };
  const findIns = (zone, zn, px) => { const refs = zn === "num" ? numCardRefs.current : denCardRefs.current; for (let i = 0; i < zone.length; i++) { const el = refs[zone[i].uid]; if (!el) continue; if (px < el.getBoundingClientRect().left + el.getBoundingClientRect().width / 2) return i; } return zone.length; };

  const onPD = (e, card, from) => { if (phase !== "playing" || wildPicker || pickPicker || opPicker) return; e.preventDefault(); e.stopPropagation(); const { x, y } = getXY(e); const r = e.currentTarget.getBoundingClientRect(); setDragOff({ x: x - r.left, y: y - r.top }); setDragPos({ x, y }); setDragging(card); setDragFrom(from); setReorderTarget(null); };

  const onPM = (e) => { if (!dragging) return; e.preventDefault(); e.stopPropagation(); const { x, y } = getXY(e); setDragPos({ x, y }); const iN = hit(numRef.current?.getBoundingClientRect(), x, y), iD = hit(denRef.current?.getBoundingClientRect(), x, y); setNumHov(iN); setDenHov(iD); if (iN) setReorderTarget({ zone: "num", index: findIns(numZone.filter(c => c.uid !== dragging.uid), "num", x) }); else if (iD) setReorderTarget({ zone: "den", index: findIns(denZone.filter(c => c.uid !== dragging.uid), "den", x) }); else setReorderTarget(null); };

  const onPU = (e) => {
    if (!dragging) return; e.preventDefault(); e.stopPropagation();
    const card = dragging, from = dragFrom, { x, y } = getXY(e);
    const iN = hit(numRef.current?.getBoundingClientRect(), x, y), iD = hit(denRef.current?.getBoundingClientRect(), x, y);
    if (iN) {
      if (from === "hand") setHand(h => h.filter(c => c.uid !== card.uid)); else if (from === "den") setDenZone(z => z.filter(c => c.uid !== card.uid));
      const f = numZone.filter(c => c.uid !== card.uid), idx = reorderTarget?.zone === "num" ? Math.min(reorderTarget.index, f.length) : f.length; const nz = [...f]; nz.splice(idx, 0, card); setNumZone(nz);
      if (card.type === "wild" && !wildMap[card.uid] && from !== "num" && from !== "den") setWildPicker(card.uid);
    } else if (iD) {
      if (from === "hand") setHand(h => h.filter(c => c.uid !== card.uid)); else if (from === "num") setNumZone(z => z.filter(c => c.uid !== card.uid));
      const f = denZone.filter(c => c.uid !== card.uid), idx = reorderTarget?.zone === "den" ? Math.min(reorderTarget.index, f.length) : f.length; const nz = [...f]; nz.splice(idx, 0, card); setDenZone(nz);
      if (card.type === "wild" && !wildMap[card.uid] && from !== "num" && from !== "den") setWildPicker(card.uid);
    } else if (from !== "hand") {
      if (from === "num") setNumZone(z => z.filter(c => c.uid !== card.uid)); else if (from === "den") setDenZone(z => z.filter(c => c.uid !== card.uid));
      if (card.type === "wild") setWildMap(w => { const n = { ...w }; delete n[card.uid]; return n; }); setHand(h => [...h, card]);
    }
    setDragging(null); setDragFrom(null); setNumHov(false); setDenHov(false); setReorderTarget(null);
  };

  const refill = (h, d) => { const need = Math.max(0, HAND_MAX - h.length), dc = Math.min(need, d.length); if (dc <= 0) return { nh: h, nd: d }; return { nh: [...h, ...d.slice(0, dc)], nd: d.slice(dc) }; };

  const doRoll = (cH, cD) => {
    setRolling(true); setNumZone([]); setDenZone([]); setWildMap({});
    const { nh, nd } = refill(cH, cD); setHand(nh); setDeck(nd); setTimer(TURN_TIME);
    let tick = 0;
    rollAnimRef.current = setInterval(() => {
      setRollDisplay({ n: Math.floor(Math.random() * 6) + 1, d: Math.floor(Math.random() * 6) + 1 });
      tick++;
      if (tick > 5) { clearInterval(rollAnimRef.current); rollAnimRef.current = null; }
    }, 150);
    setTimeout(() => {
      clearInterval(rollAnimRef.current); rollAnimRef.current = null;
      const n = rollD6(), d = rollD6(); setDiceNum(n); setDiceDen(d); setRollDisplay({ n: null, d: null }); setRolling(false);
      if (d === 5) {
        const haps = {
          1: { emoji: "\u{1f389}", text: "\u30dc\u30fc\u30ca\u30b9\uff01", detail: "\u30b9\u30b3\u30a2 +5pt", good: true },
          2: { emoji: "\u{1f631}", text: "\u30a2\u30af\u30b7\u30c7\u30f3\u30c8\uff01", detail: "\u624b\u672d\u30921\u679a\u5931\u3063\u305f\u2026", good: false },
          3: { emoji: "\u{1f0cf}", text: "\u30e9\u30c3\u30ad\u30fc\uff01", detail: "\u5c71\u672d\u304b\u30892\u679a\u8ffd\u52a0\uff01", good: true },
          4: { emoji: "\u{1f381}", text: "\u5927\u30dc\u30fc\u30ca\u30b9\uff01", detail: "\u30b9\u30b3\u30a2 +15pt", good: true },
          5: { emoji: "\u{1f494}", text: "\u3057\u307e\u3063\u305f\uff01", detail: "\u30b3\u30f3\u30dc\u304c\u30ea\u30bb\u30c3\u30c8\u2026", good: false },
          6: { emoji: "\u{1f31f}", text: "\u30dc\u30fc\u30ca\u30b9\uff01", detail: "\u30b9\u30b3\u30a2 +10pt", good: true },
        };
        setHappeningMsg(haps[n]); setPhase("happeningShow");
        setTimeout(() => {
          if (n === 1) setScore(s => s + 5); if (n === 2) setHand(h => h.length > 0 ? h.slice(0, -1) : h);
          if (n === 3) setDeck(dk => { const x = Math.min(2, dk.length); if (x > 0) { setHand(hh => [...hh, ...dk.slice(0, x)]); return dk.slice(x); } return dk; });
          if (n === 4) setScore(s => s + 15); if (n === 5) setCombo(0); if (n === 6) setScore(s => s + 10);
          setTimeout(() => { setRound(r => r + 1); setDeck(dk => { if (dk.length <= 0) setTimeout(() => { setPhase("gameOver"); setMsg("\u5de5\u623f\u9589\u5e97\uff01"); }, 100); else { setPhase("rolling"); setMsg("\u6b21\u3078"); } return dk; }); }, 1500);
        }, 800);
      } else { setMsg(nd.length <= 0 ? "\u30e9\u30b9\u30c8\uff01" : `${n}/${d}`); setPhase("playing"); }
    }, 800);
  };

  const handleRoll = () => doRoll([...hand, ...numZone, ...denZone], deck);

  const isOp = (c) => c.type === "multiply" || c.type === "add" || c.type === "subtract" || c.type === "divide";

  const calcVal = (zone) => {
    if (zone.length === 0) return null;
    const mi = zone.findIndex(c => isOp(c));
    if (mi >= 0) {
      const op = zone[mi]; const ot = zone.filter((_, i) => i !== mi);
      if (ot.length !== 2) return null;
      const v1 = ot[0].type === "wild" ? wildMap[ot[0].uid] : ot[0].value;
      const v2 = ot[1].type === "wild" ? wildMap[ot[1].uid] : ot[1].value;
      if (!v1 || !v2) return null;
      if (op.type === "multiply") return v1 * v2;
      if (op.type === "add") return v1 + v2;
      if (op.type === "subtract") return v1 - v2;
      if (op.type === "divide") return v2 !== 0 && v1 % v2 === 0 ? v1 / v2 : null;
      return null;
    }
    let num = 0; for (const c of zone) { const v = c.type === "wild" ? wildMap[c.uid] : c.value; if (!v) return null; num = num * 10 + v; } return num;
  };

  const handleSubmit = () => {
    if (numZone.length === 0 || denZone.length === 0) { setMsg("\u5206\u5b50\u3068\u5206\u6bcd\u306b\u7f6e\u3044\u3066\u306d"); return; }
    for (const c of [...numZone, ...denZone]) { if (c.type === "wild" && !wildMap[c.uid]) { setMsg("\u5316\u672d\u306e\u5024\u3092\u9078\u3093\u3067"); return; } }
    const nv = calcVal(numZone), dv = calcVal(denZone);
    if (!nv || !dv || dv === 0) { setMsg("\u6b63\u3057\u3044\u6570\u306b\u3057\u3066"); return; }
    if (Math.abs(nv / dv - diceNum / diceDen) > 0.0001) { setMsg(`${nv}/${dv} \u2260 ${diceNum}/${diceDen}`); return; }
    const used = numZone.length + denZone.length, nc = combo + 1; if (nc > maxCombo) setMaxCombo(nc);
    const base = used * 10, cb = Math.floor(base * (nc - 1) * 0.3), pts = base + cb;
    setCombo(nc); setScore(s => s + pts); setTotalUsed(t => t + used);
    setScorePopup({ points: pts, combo: nc, key: Date.now() }); setTimeout(() => setScorePopup(null), 1400);
    const rem = [...hand]; setNumZone([]); setDenZone([]); setWildMap({}); setRound(r => r + 1);
    if (deck.length <= 0 && rem.length <= 0) { setTimeout(() => { setPhase("gameOver"); setMsg("\u5de5\u623f\u9589\u5e97\uff01"); }, 1000); }
    else { setPhase("autoRolling"); setMsg(`+${pts}pt\uff01`); setTimeout(() => doRoll(rem, deck), 1000); }
  };

  const handlePass = () => {
    const all = [...hand, ...numZone, ...denZone]; setNumZone([]); setDenZone([]); setWildMap({}); setCombo(0); setMsg("\u30d1\u30b9\u2026"); setRound(r => r + 1);
    if (deck.length <= 0) { setTimeout(() => { setPhase("gameOver"); setMsg("\u5de5\u623f\u9589\u5e97\uff01"); }, 600); }
    else { setPhase("autoRolling"); setTimeout(() => doRoll(all, deck), 800); }
  };

  const useSpecial = (id) => {
    if (specials[id] <= 0 || phase !== "playing") return;
    setSpecials(s => ({ ...s, [id]: s[id] - 1 }));
    if (id === "redraw") { const all = shuffle([...deck, ...hand, ...numZone, ...denZone]); setNumZone([]); setDenZone([]); setWildMap({}); setHand(all.slice(0, HAND_MAX).map(c => ({ ...c, uid: c.uid || mkUid() }))); setDeck(all.slice(HAND_MAX)); setMsg("\u{1f504} \u5f15\u304d\u76f4\u3057\u305f\uff01"); }
    if (id === "reroll") {
      setHand(h => [...h, ...numZone, ...denZone]); setNumZone([]); setDenZone([]); setWildMap({}); setRolling(true); setTimer(TURN_TIME);
      let tick = 0;
      rollAnimRef.current = setInterval(() => { setRollDisplay({ n: Math.floor(Math.random() * 6) + 1, d: Math.floor(Math.random() * 6) + 1 }); tick++; if (tick > 5) { clearInterval(rollAnimRef.current); } }, 150);
      setTimeout(() => { clearInterval(rollAnimRef.current); const n = rollD6(), d = rollD6(); setDiceNum(n); setDiceDen(d); setRollDisplay({ n: null, d: null }); setRolling(false); setMsg(`\u{1f3b2} ${n}/${d}`); }, 800);
    }
    if (id === "pick") setPickPicker(true);
    if (id === "pickop") setOpPicker(true);
  };

  const nv = calcVal(numZone), dv = calcVal(denZone);
  const match = nv && dv && dv !== 0 && Math.abs(nv / dv - diceNum / diceDen) < 0.0001;
  const previewPts = match ? (numZone.length + denZone.length) * 10 + Math.floor((numZone.length + denZone.length) * 10 * combo * 0.3) : 0;

  const P = "#faf3e6"; const INK = "#3e2723"; const W = "linear-gradient(180deg,#d4a96a,#c49556 40%,#b8894d)"; const WD = "linear-gradient(180deg,#7a6340,#6b5636)"; const WM = "#e8b84b"; const RA = "#c0392b"; const BA = "#2e86ab";
  const ZW = 36; const ZH = 50; const HW = 46; const HH = 58;

  const cSt = (card, sm) => {
    const isW = card.type === "wild", isOpc = card.type === "multiply" || card.type === "add" || card.type === "subtract" || card.type === "divide"; const w = sm ? ZW : HW, h = sm ? ZH : HH;
    return { width: w, height: h, borderRadius: sm ? 5 : 7, background: isW ? "linear-gradient(180deg,#fff8e1,#ffe0b2)" : isOpc ? "linear-gradient(180deg,#f3e5f5,#e1bee7)" : `linear-gradient(180deg,${P},#f0e6d3)`, border: `2px solid ${isW ? "#e67e22" : isOpc ? "#8e44ad" : "#a08060"}`, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", cursor: phase === "playing" ? "grab" : "default", fontFamily: "'Zen Maru Gothic',serif", color: isW ? "#e65100" : isOpc ? "#6a1b9a" : INK, userSelect: "none", touchAction: "none", WebkitUserSelect: "none", boxShadow: "1px 2px 4px rgba(62,39,35,0.18)", flexShrink: 0 };
  };

  const rCard = (card, from, refMap) => {
    const wv = wildMap[card.uid], isDrag = dragging?.uid === card.uid, sm = from === "num" || from === "den";
    const opLabel = { multiply: "\u4e57\u672d", add: "\u52a0\u672d", subtract: "\u6e1b\u672d", divide: "\u9664\u672d" };
    return (<div key={card.uid} ref={el => { if (refMap) refMap[card.uid] = el; }} onPointerDown={e => onPD(e, card, from)} onTouchStart={e => onPD(e, card, from)} style={{ ...cSt(card, sm), opacity: isDrag ? 0.2 : 1 }}><span style={{ fontSize: sm ? 15 : 20, fontWeight: 800, lineHeight: 1 }}>{cardLabel(card, wv)}</span>{opLabel[card.type] && <span style={{ fontSize: 7, fontWeight: 700, opacity: 0.6 }}>{opLabel[card.type]}</span>}{card.type === "wild" && !wv && <span style={{ fontSize: 7, fontWeight: 700, opacity: 0.6 }}>{"\u5316\u672d"}</span>}</div>);
  };

  const rGhost = () => { if (!dragging) return null; return (<div style={{ ...cSt(dragging, false), position: "fixed", left: dragPos.x - dragOff.x, top: dragPos.y - dragOff.y, boxShadow: "0 8px 28px rgba(62,39,35,0.35)", zIndex: 9999, pointerEvents: "none", transform: "rotate(3deg) scale(1.08)" }}><span style={{ fontSize: 20, fontWeight: 800 }}>{cardLabel(dragging, wildMap[dragging.uid])}</span></div>); };

  const rZone = (label, zone, ref, hov, accent, crm) => {
    const val = calcVal(zone), zn = label === "\u5206\u5b50" ? "num" : "den", si = reorderTarget?.zone === zn && dragging, ii = si ? reorderTarget.index : -1, dz = zone.filter(c => c.uid !== dragging?.uid);
    return (<div ref={ref} style={{ minHeight: ZH + 10, borderRadius: 9, width: "100%", background: hov ? "rgba(232,184,75,0.22)" : "rgba(255,255,255,0.3)", border: hov ? `2.5px solid ${WM}` : "2px dashed rgba(139,111,71,0.3)", padding: "3px 4px", display: "flex", alignItems: "center", gap: 4, transition: "all 0.15s" }}>
      <div style={{ display: "flex", flexDirection: "column", alignItems: "center", minWidth: 30 }}><span style={{ fontSize: 10, fontWeight: 800, color: accent }}>{label}</span><span style={{ fontSize: 16, fontWeight: 900, color: INK }}>{val ?? "\u2014"}</span></div>
      <div style={{ display: "flex", gap: 2, flex: 1, minHeight: ZH, alignItems: "center" }}>
        {dz.length === 0 && !si && <span style={{ fontSize: 10, color: "rgba(139,111,71,0.3)", fontStyle: "italic" }}>{hov ? "\uff0b" : "\u2190 \u30c9\u30e9\u30c3\u30b0"}</span>}
        {dz.map((c, i) => (<div key={c.uid} style={{ display: "flex", alignItems: "center" }}>{si && ii === i && <div style={{ width: 3, height: ZH - 4, background: WM, borderRadius: 2, flexShrink: 0 }} />}{rCard(c, zn, crm)}</div>))}
        {si && ii >= dz.length && <div style={{ width: 3, height: ZH - 4, background: WM, borderRadius: 2, flexShrink: 0 }} />}
      </div>
    </div>);
  };

  const tPct = mode === "normal" ? (timer / TURN_TIME) * 100 : 100;
  const tCol = timer <= 10 ? "#e53935" : timer <= 20 ? "#ff9800" : "#4caf50";

  if (phase === "title") {
    return (
      <div style={{ minHeight: "100vh", background: "linear-gradient(180deg,#f5e6c8,#e8d5a8 30%,#d4b88c)", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", fontFamily: "'Zen Maru Gothic',serif", color: INK, padding: 16, textAlign: "center", position: "relative", overflow: "hidden" }}>
        <style>{`@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}@keyframes fadeIn{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}@keyframes diceRoll{0%{transform:rotate(0) scale(1)}50%{transform:rotate(180deg) scale(1.2)}100%{transform:rotate(360deg) scale(1)}}@keyframes popUp{0%{opacity:0;transform:translate(-50%,-40%) scale(0.5)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}40%{transform:translate(-50%,-50%) scale(1)}80%{opacity:1;transform:translate(-50%,-60%) scale(1)}100%{opacity:0;transform:translate(-50%,-80%) scale(0.8)}}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}*{box-sizing:border-box;margin:0;padding:0}`}</style>
        <div style={{ animation: "float 3s ease-in-out infinite", marginBottom: 12 }}>
          <div style={{ fontSize: 15, color: "#8b6f47", letterSpacing: 6, marginBottom: 6, fontWeight: 700 }}>{"\u{1f528} \u3088\u3046\u3053\u305d \u{1fa9a}"}</div>
          <div style={{ fontSize: 52, fontWeight: 900, color: INK, letterSpacing: 6, textShadow: "2px 2px 0 rgba(212,169,106,0.6)" }}>{"\u7d04\u5206\u5de5\u623f"}</div>
          <div style={{ width: 80, height: 3, background: WM, margin: "10px auto 0", borderRadius: 2 }} />
        </div>
        <div style={{ background: `linear-gradient(180deg,${P},#f0e6d3)`, border: "3px solid #a08060", borderRadius: 14, padding: "18px 22px", marginBottom: 24, maxWidth: 340, boxShadow: "2px 4px 16px rgba(62,39,35,0.12)", position: "relative" }}>
          <div style={{ position: "absolute", top: -9, left: "50%", transform: "translateX(-50%)", background: RA, color: "#fff", fontSize: 10, fontWeight: 800, padding: "2px 14px", borderRadius: 10, letterSpacing: 2 }}>{"\u904a\u3073\u65b9"}</div>
          <div style={{ fontSize: 14, color: "#5d4037", lineHeight: 2, marginTop: 8 }}>
            {"\u{1f3b2} \u30b5\u30a4\u30b3\u30ed\u3067\u5206\u6570\u306e\u6ce8\u6587\u304c\u304f\u308b"}<br />
            {"\u{1f0cf} \u624b\u672d\u3067\u540c\u3058\u5024\u306e\u5206\u6570\u3092\u4f5c\u308d\u3046"}<br />
            {"\u{1f4e6} \u30ab\u30fc\u30c9\u3092\u591a\u304f\u4f7f\u3046\u307b\u3069\u9ad8\u5f97\u70b9"}<br />
            {"\u{1f525} \u9023\u7d9a\u7d0d\u54c1\u3067\u30b3\u30f3\u30dc\u30dc\u30fc\u30ca\u30b9"}<br />
            {"\u2b50 \u7279\u5225\u30ab\u30fc\u30c94\u7a2e\u3067\u5207\u308a\u629c\u3051\u308d"}<br />
            {"\u{1f3c1} \u5c71\u672d\u304c\u306a\u304f\u306a\u3063\u305f\u3089\u9589\u5e97\uff01"}
          </div>
        </div>
        <div style={{ display: "flex", gap: 12, marginBottom: 10 }}>
          <button onClick={() => startGame("normal")} style={{ padding: "14px 30px", fontSize: 18, fontWeight: 900, fontFamily: "'Zen Maru Gothic',serif", background: W, color: "#fff", border: "3px solid #a08060", borderRadius: 14, cursor: "pointer", letterSpacing: 3 }}>{"\u23f1\ufe0f \u672c\u756a"}<br /><span style={{ fontSize: 11 }}>{"60\u79d2\u5236"}</span></button>
          <button onClick={() => startGame("practice")} style={{ padding: "14px 30px", fontSize: 18, fontWeight: 900, fontFamily: "'Zen Maru Gothic',serif", background: "linear-gradient(180deg,#81c784,#66bb6a)", color: "#fff", border: "3px solid #4caf50", borderRadius: 14, cursor: "pointer", letterSpacing: 3 }}>{"\u{1f4dd} \u7df4\u7fd2"}<br /><span style={{ fontSize: 11 }}>{"\u7121\u5236\u9650"}</span></button>
        </div>
      </div>
    );
  }

  const deckMax = DECK_SIZE - HAND_MAX;
  const deckPct = deckMax > 0 ? Math.round((deck.length / deckMax) * 100) : 0;
  const handTotal = hand.length + numZone.length + denZone.length;

  return (
    <div onPointerMove={onPM} onPointerUp={onPU} onPointerCancel={onPU} onTouchMove={onPM} onTouchEnd={onPU} onTouchCancel={onPU}
      style={{ height: "100vh", overflow: "hidden", background: "linear-gradient(180deg,#e8d5a8,#d4b88c 50%,#c4a87a)", fontFamily: "'Zen Maru Gothic',serif", color: INK, padding: "3px 3px", display: "flex", flexDirection: "column", gap: 2, touchAction: "none", userSelect: "none", WebkitUserSelect: "none", position: "relative", overscrollBehavior: "none" }}>
      <style>{`@keyframes diceRoll{0%{transform:rotate(0) scale(1)}50%{transform:rotate(180deg) scale(1.2)}100%{transform:rotate(360deg) scale(1)}}@keyframes diceShake{0%,100%{transform:translate(0,0) rotate(0)}10%{transform:translate(-3px,2px) rotate(-8deg)}20%{transform:translate(3px,-2px) rotate(6deg)}30%{transform:translate(-2px,3px) rotate(-4deg)}40%{transform:translate(2px,-1px) rotate(8deg)}50%{transform:translate(-3px,1px) rotate(-6deg)}60%{transform:translate(3px,2px) rotate(4deg)}70%{transform:translate(-1px,-3px) rotate(-8deg)}80%{transform:translate(2px,3px) rotate(6deg)}90%{transform:translate(-2px,-1px) rotate(-4deg)}}@keyframes diceLand{0%{transform:scale(1.3) rotate(10deg)}40%{transform:scale(0.9) rotate(-3deg)}70%{transform:scale(1.05) rotate(1deg)}100%{transform:scale(1) rotate(0)}}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@keyframes popUp{0%{opacity:0;transform:translate(-50%,-40%) scale(0.5)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}40%{transform:translate(-50%,-50%) scale(1)}80%{opacity:1;transform:translate(-50%,-60%) scale(1)}100%{opacity:0;transform:translate(-50%,-80%) scale(0.8)}}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}*{box-sizing:border-box;margin:0;padding:0}html,body{overflow:hidden;overscroll-behavior:none}`}</style>
      {rGhost()}
      {scorePopup && (<div key={scorePopup.key} style={{ position: "absolute", top: "30%", left: "50%", zIndex: 150, pointerEvents: "none", animation: "popUp 1.4s ease-out forwards" }}><div style={{ background: "linear-gradient(135deg,#ff6f00,#ff8f00)", color: "#fff", borderRadius: 16, padding: "14px 28px", textAlign: "center", boxShadow: "0 4px 24px rgba(255,111,0,0.4)", border: "3px solid #ffe082" }}><div style={{ fontSize: 36, fontWeight: 900, textShadow: "2px 2px 4px rgba(0,0,0,0.2)" }}>+{scorePopup.points}<span style={{ fontSize: 16 }}>pt</span></div>{scorePopup.combo > 1 && <div style={{ fontSize: 16, fontWeight: 800, marginTop: 2 }}>{"\u{1f525}"}{scorePopup.combo}{"\u30b3\u30f3\u30dc\uff01"}</div>}</div></div>)}
      {/* Header */}
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "4px 8px", background: WD, borderRadius: 10, flexShrink: 0 }}>
        <div style={{ fontSize: 15, fontWeight: 900, color: "#faf3e6", letterSpacing: 3 }}>{"\u{1f528} \u7d04\u5206\u5de5\u623f"}</div>
        <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
          {mode === "practice" && <span style={{ fontSize: 10, color: "#a5d6a7", fontWeight: 800, background: "rgba(165,214,167,0.15)", padding: "1px 6px", borderRadius: 4 }}>{"\u7df4\u7fd2"}</span>}
          <span style={{ fontSize: 11, color: "rgba(250,243,230,0.6)", fontWeight: 700 }}>R{round}</span>
          {combo > 1 && <span style={{ fontSize: 11, color: "#ffd54f", fontWeight: 900 }}>{"\u{1f525}"}{combo}</span>}
          {mode === "normal" && phase === "playing" && <span style={{ fontSize: 16, fontWeight: 900, color: timer <= 10 ? "#ff5252" : timer <= 20 ? "#ffab40" : "#faf3e6", minWidth: 32, textAlign: "right", animation: timer <= 10 ? "pulse 0.5s infinite" : "none" }}>{timer}s</span>}
        </div>
        <button onClick={() => setPhase("title")} style={{ background: "rgba(250,243,230,0.15)", border: "none", color: "rgba(250,243,230,0.6)", padding: "3px 10px", borderRadius: 7, cursor: "pointer", fontSize: 11, fontFamily: "'Zen Maru Gothic',serif", fontWeight: 700 }}>{"\u2715"}</button>
      </div>
      {/* Timer bar */}
      {mode === "normal" && phase === "playing" && (<div style={{ height: 5, background: "rgba(139,111,71,0.15)", borderRadius: 3, margin: "0 2px", flexShrink: 0 }}><div style={{ height: "100%", width: `${tPct}%`, background: tCol, borderRadius: 3, transition: "width 1s linear, background 0.3s" }} /></div>)}
      {/* Score row */}
      <div style={{ display: "flex", gap: 3, padding: "0 1px", flexShrink: 0 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 5, background: "rgba(255,255,255,0.45)", borderRadius: 10, padding: "4px 10px", border: "2px solid rgba(192,57,43,0.15)", flex: 1.5 }}>
          <span style={{ fontSize: 20 }}>{"\u{1f3c6}"}</span>
          <div><div style={{ fontSize: 9, color: "#8b6f47", fontWeight: 700 }}>{"\u30b9\u30b3\u30a2"}</div><div style={{ fontSize: 24, fontWeight: 900, color: RA, lineHeight: 1 }}>{score}<span style={{ fontSize: 10 }}>pt</span></div></div>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 3, background: "rgba(255,255,255,0.35)", borderRadius: 10, padding: "4px 8px", border: "1px solid rgba(160,128,96,0.3)", flex: 1 }}>
          <span style={{ fontSize: 16 }}>{"\u{1f4e6}"}</span>
          <div><div style={{ fontSize: 9, color: "#8b6f47", fontWeight: 700 }}>{"\u5c71\u672d"}</div><div style={{ fontSize: 18, fontWeight: 900, color: deck.length <= 5 ? RA : BA }}>{"\u6b8b"}{deck.length}</div></div>
        </div>
      </div>
      {/* Deck bar */}
      <div style={{ height: 4, background: "rgba(139,111,71,0.15)", borderRadius: 2, margin: "0 2px", flexShrink: 0 }}>
        <div style={{ height: "100%", width: `${deckPct}%`, background: deck.length <= 5 ? RA : WM, borderRadius: 2, transition: "width 0.4s" }} />
      </div>
      {/* Main: Order + Workbench */}
      <div style={{ display: "flex", gap: 4, flexShrink: 0 }}>
        <div style={{ background: `linear-gradient(180deg,${P},#f0e6d3)`, border: "2px solid #a08060", borderRadius: 12, padding: "6px 8px", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", gap: 3, minWidth: 72 }}>
          <div style={{ fontSize: 10, color: "#8b6f47", fontWeight: 800, letterSpacing: 2 }}>{"\u{1f4cb}\u6ce8\u6587"}</div>
          <div style={{ width: 54, height: 54, borderRadius: 10, background: "linear-gradient(135deg,#5c9ead,#4a8a99)", border: "3px solid #3d7a88", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 30, fontWeight: 900, color: "#fff", boxShadow: "1px 2px 8px rgba(0,0,0,0.2)", animation: rolling ? "diceRoll 0.4s" : "none" }}>{rolling ? (rollDisplay.n || "?") : (diceNum || "?")}</div>
          <div style={{ width: 50, height: 5, background: "#8b6f47", borderRadius: 3 }} />
          <div style={{ width: 54, height: 54, borderRadius: 10, background: "linear-gradient(135deg,#c0392b,#a93226)", border: "3px solid #922b21", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 30, fontWeight: 900, color: "#fff", boxShadow: "1px 2px 8px rgba(0,0,0,0.2)", animation: rolling ? "diceRoll 0.4s" : "none" }}>{rolling ? (rollDisplay.d || "?") : (diceDen || "?")}</div>
          {phase === "rolling" && !rolling && (<button onClick={handleRoll} style={{ marginTop: 3, padding: "7px 14px", fontSize: 14, fontWeight: 900, fontFamily: "'Zen Maru Gothic',serif", background: W, color: "#fff", border: "2px solid #a08060", borderRadius: 10, cursor: "pointer", letterSpacing: 2 }}>{"\u{1f3b2}\u632f\u308b"}</button>)}
          {(rolling || phase === "autoRolling") && <div style={{ fontSize: 12, color: "#8b6f47", fontWeight: 700, marginTop: 3 }}>{"\u{1f3b2} \u30b3\u30ed\u30b3\u30ed\u2026"}</div>}
        </div>
        {(phase === "playing" || phase === "autoRolling") && (
          <div style={{ flex: 1, background: "rgba(255,255,255,0.22)", borderRadius: 12, border: "2px solid rgba(160,128,96,0.3)", padding: "4px 5px", display: "flex", flexDirection: "column", gap: 0, minWidth: 0, animation: "fadeIn 0.3s" }}>
            <div style={{ fontSize: 10, color: "#8b6f47", fontWeight: 700, textAlign: "center", letterSpacing: 2, marginBottom: 2 }}>{"\u{1fab5} \u4f5c\u696d\u53f0"}</div>
            {rZone("\u5206\u5b50", numZone, numRef, numHov, BA, numCardRefs.current)}
            <div style={{ width: "95%", height: 4, background: "#8b6f47", borderRadius: 2, margin: "2px auto" }} />
            {rZone("\u5206\u6bcd", denZone, denRef, denHov, RA, denCardRefs.current)}
          </div>
        )}
        {phase === "happeningShow" && (
          <div style={{ flex: 1, borderRadius: 12, display: "flex", alignItems: "center", justifyContent: "center" }}>
            <div style={{ fontSize: 14, color: "#8b6f47", fontWeight: 700 }}>{"\u26a1\u2026"}</div>
          </div>
        )}
      </div>
      {/* Happening full overlay */}
      {phase === "happeningShow" && happeningMsg && (
        <div style={{ position: "absolute", inset: 0, background: happeningMsg.good ? "rgba(27,94,32,0.55)" : "rgba(183,28,28,0.55)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 120, backdropFilter: "blur(3px)", animation: "fadeIn 0.3s" }}>
          <div style={{ textAlign: "center", padding: "28px 24px", background: happeningMsg.good ? "linear-gradient(180deg,#e8f5e9,#c8e6c9)" : "linear-gradient(180deg,#fce4ec,#f8bbd0)", border: `3px solid ${happeningMsg.good ? "#4caf50" : "#e53935"}`, borderRadius: 20, margin: "0 20px", boxShadow: `0 8px 32px ${happeningMsg.good ? "rgba(76,175,80,0.3)" : "rgba(229,57,53,0.3)"}`, maxWidth: 300, width: "100%" }}>
            <div style={{ fontSize: 56, lineHeight: 1, marginBottom: 8 }}>{happeningMsg.emoji}</div>
            <div style={{ fontSize: 10, fontWeight: 800, color: "#fff", background: happeningMsg.good ? "#4caf50" : "#e53935", padding: "3px 14px", borderRadius: 12, display: "inline-block", letterSpacing: 3, marginBottom: 8 }}>{"\u26a1 \u30cf\u30d7\u30cb\u30f3\u30b0"}</div>
            <div style={{ fontSize: 22, fontWeight: 900, color: happeningMsg.good ? "#2e7d32" : "#c62828", marginBottom: 6 }}>{happeningMsg.text}</div>
            <div style={{ fontSize: 16, fontWeight: 800, color: happeningMsg.good ? "#388e3c" : "#d32f2f", lineHeight: 1.4 }}>{happeningMsg.detail}</div>
          </div>
        </div>
      )}
      {/* Actions */}
      {phase === "playing" && (
        <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 6, flexShrink: 0 }}>
          {nv != null && dv != null && <span style={{ fontSize: 14, fontWeight: 900, color: match ? "#2e7d32" : "#c62828", background: match ? "rgba(46,125,50,0.12)" : "rgba(198,40,40,0.08)", padding: "2px 10px", borderRadius: 8 }}>{nv}/{dv} {match ? "\u2705" : "\u274c"}</span>}
          {match && <span style={{ fontSize: 13, color: "#e65100", fontWeight: 900, background: "rgba(255,111,0,0.12)", padding: "2px 8px", borderRadius: 6 }}>+{previewPts}pt</span>}
          <button onClick={handleSubmit} disabled={!match} style={{ padding: "7px 18px", fontSize: 15, fontWeight: 900, fontFamily: "'Zen Maru Gothic',serif", background: match ? "linear-gradient(135deg,#4caf50,#388e3c)" : "#999", color: "#fff", border: match ? "2px solid #2e7d32" : "2px solid #888", borderRadius: 10, cursor: match ? "pointer" : "default", letterSpacing: 3 }}>{"\u{1f4e6}\u7d0d\u54c1"}</button>
          <button onClick={handlePass} style={{ padding: "6px 12px", fontSize: 13, fontWeight: 700, fontFamily: "'Zen Maru Gothic',serif", background: "rgba(139,111,71,0.12)", color: "#8b6f47", border: "1.5px solid rgba(139,111,71,0.3)", borderRadius: 9, cursor: "pointer" }}>{"\u30d1\u30b9"}</button>
        </div>
      )}
      {/* Hand */}
      <div style={{ padding: "4px 4px", minHeight: 0, flex: 1, background: "rgba(255,255,255,0.3)", borderRadius: 10, border: "2px solid rgba(160,128,96,0.25)", display: "flex", flexDirection: "column", overflow: "hidden" }}>
        <div style={{ fontSize: 10, color: "#8b6f47", marginBottom: 2, paddingLeft: 3, fontWeight: 700, flexShrink: 0 }}>{"\u{1f0cf} \u624b\u672d ("}{handTotal}{")"}</div>
        <div data-scrollable="true" style={{ display: "flex", gap: 4, flexWrap: "wrap", justifyContent: "center", alignContent: "flex-start", overflowY: "auto", flex: 1, padding: "1px 0" }}>
          {hand.map(c => rCard(c, "hand", null))}
        </div>
      </div>
      {/* Specials - 2x2 grid */}
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 3, padding: "0 1px", flexShrink: 0 }}>
        {SPECIALS.map(sp => {
          const cnt = specials[sp.id], dis = cnt <= 0 || phase !== "playing";
          return (<button key={sp.id} onClick={() => useSpecial(sp.id)} disabled={dis} style={{
            display: "flex", alignItems: "center", justifyContent: "center", gap: 5,
            padding: "6px 4px", borderRadius: 10, cursor: dis ? "default" : "pointer",
            background: dis ? "rgba(139,111,71,0.06)" : "linear-gradient(180deg,#fff8e1,#ffcc80)",
            border: dis ? "2px solid rgba(139,111,71,0.12)" : "2.5px solid #e67e22",
            opacity: dis ? 0.3 : 1, fontFamily: "'Zen Maru Gothic',serif",
            boxShadow: dis ? "none" : "0 2px 8px rgba(230,126,34,0.25)", transition: "all 0.15s",
          }}>
            <span style={{ fontSize: 22 }}>{sp.emoji}</span>
            <div style={{ textAlign: "left" }}>
              <div style={{ fontSize: 11, fontWeight: 900, color: dis ? "#999" : "#e65100", lineHeight: 1.1 }}>{sp.name}</div>
              <div style={{ fontSize: 9, color: dis ? "#bbb" : "#a08060" }}>{"\u6b8b"}{cnt}</div>
            </div>
          </button>);
        })}
      </div>
      {/* Message */}
      <div style={{ textAlign: "center", fontSize: 12, color: "#5d4037", padding: "1px", minHeight: 16, fontWeight: 700, flexShrink: 0 }}>{msg}</div>
      {/* Game over */}
      {phase === "gameOver" && (<div style={{ position: "absolute", inset: 0, background: "rgba(62,39,35,0.5)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 100, backdropFilter: "blur(3px)" }}><div style={{ textAlign: "center", padding: 24, background: `linear-gradient(180deg,${P},#f0e6d3)`, border: "3px solid #a08060", borderRadius: 16, margin: "0 14px", animation: "fadeIn 0.5s", maxWidth: 360, width: "100%" }}>
        <div style={{ fontSize: 22, fontWeight: 900, marginBottom: 8 }}>{"\u{1f3c6} \u5de5\u623f\u9589\u5e97\uff01"}</div>
        {mode === "practice" && <div style={{ fontSize: 12, color: "#4caf50", fontWeight: 700, marginBottom: 4 }}>{"\u{1f4dd} \u7df4\u7fd2\u30e2\u30fc\u30c9"}</div>}
        <div style={{ fontSize: 48, fontWeight: 900, color: RA, marginBottom: 4 }}>{score}<span style={{ fontSize: 16 }}>pt</span></div>
        <div style={{ fontSize: 13, color: "#8b6f47", marginBottom: 12 }}>{"\u5168"}{round - 1}{"\u30e9\u30a6\u30f3\u30c9 \u30fb "}{totalUsed}{"\u679a\u4f7f\u7528 \u30fb \u6700\u5927"}{maxCombo}{"\u30b3\u30f3\u30dc"}</div>
        <div style={{ fontSize: 16, fontWeight: 800, color: "#5d4037", marginBottom: 18 }}>{score >= 300 ? "\u2b50\u2b50\u2b50 \u4f1d\u8aac\u306e\u8077\u4eba\uff01" : score >= 180 ? "\u2b50\u2b50 \u4e00\u6d41\u306e\u8155\u524d\uff01" : score >= 80 ? "\u2b50 \u306a\u304b\u306a\u304b\u306e\u4ed5\u4e0a\u304c\u308a\uff01" : "\u4fee\u884c\u3042\u308b\u306e\u307f\uff01"}</div>
        <button onClick={() => setPhase("title")} style={{ padding: "12px 30px", fontSize: 17, fontWeight: 900, fontFamily: "'Zen Maru Gothic',serif", background: W, color: "#fff", border: "2px solid #a08060", borderRadius: 12, cursor: "pointer", letterSpacing: 4 }}>{"\u{1f528} \u3082\u3046\u4e00\u5ea6"}</button>
      </div></div>)}
      {/* Wild picker */}
      {wildPicker !== null && (<div style={{ position: "fixed", inset: 0, background: "rgba(62,39,35,0.5)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 200, backdropFilter: "blur(2px)" }}><div style={{ background: P, borderRadius: 16, padding: 24, border: "3px solid #a08060", textAlign: "center" }}><div style={{ fontSize: 15, marginBottom: 12, color: "#e65100", fontWeight: 800 }}>{"\u2b50 \u5316\u672d\u306e\u6570\u5b57\u3092\u9078\u3093\u3067\u306d"}</div><div style={{ display: "flex", gap: 6, flexWrap: "wrap", justifyContent: "center" }}>{[1,2,3,4,5,6,7,8,9].map(v => (<button key={v} onClick={() => { setWildMap(w => ({ ...w, [wildPicker]: v })); setWildPicker(null); }} style={{ width: 44, height: 44, borderRadius: 10, background: "linear-gradient(180deg,#fff8e1,#ffe0b2)", border: "2px solid #e67e22", color: "#e65100", fontSize: 20, fontWeight: 900, fontFamily: "'Zen Maru Gothic',serif", cursor: "pointer" }}>{v}</button>))}</div></div></div>)}
      {/* Pick number */}
      {pickPicker && (<div style={{ position: "fixed", inset: 0, background: "rgba(62,39,35,0.5)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 200, backdropFilter: "blur(2px)" }}><div style={{ background: P, borderRadius: 16, padding: 24, border: "3px solid #a08060", textAlign: "center" }}><div style={{ fontSize: 15, marginBottom: 12, color: "#2e7d32", fontWeight: 800 }}>{"\u{1f522} \u624b\u672d\u306b\u52a0\u3048\u308b\u6570\u5b57\u3092\u9078\u307c\u3046"}</div><div style={{ display: "flex", gap: 6, flexWrap: "wrap", justifyContent: "center" }}>{[1,2,3,4,5,6,7,8,9].map(v => (<button key={v} onClick={() => { setHand(h => [...h, { type: "number", value: v, uid: mkUid() }]); setPickPicker(false); setMsg(`\u{1f522} ${v}\u3092\u8ffd\u52a0\uff01`); }} style={{ width: 44, height: 44, borderRadius: 10, background: `linear-gradient(180deg,${P},#f0e6d3)`, border: "2px solid #a08060", color: INK, fontSize: 20, fontWeight: 900, fontFamily: "'Zen Maru Gothic',serif", cursor: "pointer" }}>{v}</button>))}</div></div></div>)}
      {/* Pick operation */}
      {opPicker && (<div style={{ position: "fixed", inset: 0, background: "rgba(62,39,35,0.5)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 200, backdropFilter: "blur(2px)" }}><div style={{ background: P, borderRadius: 16, padding: 24, border: "3px solid #a08060", textAlign: "center" }}><div style={{ fontSize: 15, marginBottom: 14, color: "#6a1b9a", fontWeight: 800 }}>{"\u2728 \u624b\u672d\u306b\u52a0\u3048\u308b\u6f14\u7b97\u3092\u9078\u307c\u3046"}</div><div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, justifyContent: "center" }}>
        {[{ type: "add", sym: "\uff0b", name: "\u52a0\u672d" }, { type: "subtract", sym: "\u2212", name: "\u6e1b\u672d" }, { type: "multiply", sym: "\u00d7", name: "\u4e57\u672d" }, { type: "divide", sym: "\u00f7", name: "\u9664\u672d" }].map(op => (
          <button key={op.type} onClick={() => { setHand(h => [...h, { type: op.type, uid: mkUid() }]); setOpPicker(false); setMsg(`\u2728 ${op.name}\u3092\u8ffd\u52a0\uff01`); }} style={{ width: 72, height: 72, borderRadius: 14, background: "linear-gradient(180deg,#f3e5f5,#e1bee7)", border: "3px solid #8e44ad", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", cursor: "pointer", fontFamily: "'Zen Maru Gothic',serif" }}>
            <span style={{ fontSize: 30, fontWeight: 900, color: "#6a1b9a" }}>{op.sym}</span>
            <span style={{ fontSize: 10, fontWeight: 800, color: "#6a1b9a" }}>{op.name}</span>
          </button>
        ))}
      </div></div></div>)}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<YakubunKoubou />);
</script>
</body>
</html>
