<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åˆ†æ•°èåˆ - TRAIL æ¢ç©¶ã‚²ãƒ¼ãƒ ãƒ©ãƒ³ãƒ‰</title>
<meta name="description" content="åˆ†æ•°ã‚’ãŸã—ã¦ç›®æ¨™ã®æ•°ã‚’ã¤ãã‚ã†ï¼åˆ†æ•°ã®è¶³ã—ç®—ãŒæ¥½ã—ãèº«ã«ã¤ãã‚²ãƒ¼ãƒ ã€‚">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”¬</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #eef6ff;
    --accent: #3a7bd5;
    --accent-light: #6fa3ef;
    --accent-glow: rgba(58,123,213,0.2);
    --green: #27ae60;
    --red: #e74c3c;
    --gold: #f39c12;
    --text: #1a2a3a;
    --text-mid: #5a6a7a;
    --card: #ffffff;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Zen Maru Gothic', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }
  .game-header {
    background: linear-gradient(135deg, #2c3e7a, #3a7bd5, #5a9bf5);
    color: white; text-align: center; padding: 16px 16px 20px;
    position: relative;
  }
  .game-header::after {
    content: ''; position: absolute; bottom: -8px; left: 0; right: 0; height: 16px;
    background: var(--bg); border-radius: 16px 16px 0 0;
  }
  .back-btn {
    position: absolute; top: 12px; left: 12px;
    background: rgba(255,255,255,0.15); border: none; color: white;
    font-size: 20px; width: 36px; height: 36px; border-radius: 50%;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-family: 'Zen Maru Gothic', sans-serif;
  }
  .back-btn:hover { background: rgba(255,255,255,0.25); }
  .header-emoji { font-size: 32px; }
  .header-title { font-size: 22px; font-weight: 900; }
  .header-sub { font-size: 11px; opacity: 0.8; margin-top: 2px; }

  .container { max-width: 480px; margin: 0 auto; padding: 0 16px 60px; }

  .screen { display: none; }
  .screen.active { display: block; }

  /* Start */
  .start-area { text-align: center; padding-top: 30px; }
  .start-icon { font-size: 72px; margin-bottom: 12px; animation: pulse 2s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
  .start-title { font-size: 24px; font-weight: 900; margin-bottom: 8px; }
  .start-desc { font-size: 14px; color: var(--text-mid); line-height: 1.8; margin-bottom: 20px; }
  .rules-box {
    background: var(--card); border-radius: 16px; padding: 18px 20px;
    text-align: left; margin-bottom: 28px; border: 2px solid #d0e0f0;
  }
  .rules-box h3 { font-size: 14px; font-weight: 900; margin-bottom: 10px; }
  .rules-box ul { list-style: none; font-size: 13px; color: var(--text-mid); line-height: 2.2; }
  .rules-box li::before { content: 'âœ¨ '; }
  .start-btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 16px 40px; border-radius: 16px; border: none;
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    color: white; font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 18px; font-weight: 900; cursor: pointer;
    box-shadow: 0 4px 16px var(--accent-glow);
  }
  .start-btn:active { transform: scale(0.96); }

  /* HUD */
  .hud {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 0 10px; font-size: 13px; font-weight: 700;
  }
  .hud-item { display: flex; align-items: center; gap: 4px; }
  .hud-score { font-family: 'Fredoka', sans-serif; color: var(--accent); font-size: 15px; }
  .hud-timer { font-family: 'Fredoka', sans-serif; color: var(--gold); font-size: 15px; }
  .hud-round { color: var(--text-mid); }

  /* Fusion Area */
  .fusion-card {
    background: var(--card); border-radius: 20px; padding: 24px 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06); border: 2px solid #d0e0f0;
    text-align: center; animation: slideIn 0.4s ease;
  }
  @keyframes slideIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

  .target-area { margin-bottom: 20px; }
  .target-label { font-size: 12px; color: var(--text-mid); font-weight: 700; margin-bottom: 6px; }
  .target-fraction { display: inline-flex; flex-direction: column; align-items: center; gap: 0; }
  .target-fraction .numer, .target-fraction .denom {
    font-family: 'Fredoka', sans-serif; font-size: 36px; font-weight: 700; color: var(--accent); line-height: 1.1;
  }
  .target-fraction .frac-line {
    width: 60px; height: 4px; background: var(--accent); border-radius: 2px;
  }

  .fusion-label { font-size: 13px; color: var(--text-mid); font-weight: 700; margin-bottom: 14px; }
  .operands {
    display: flex; align-items: center; justify-content: center; gap: 14px;
    margin-bottom: 20px; flex-wrap: wrap;
  }
  .frac-display {
    display: inline-flex; flex-direction: column; align-items: center;
    background: #f0f6ff; border-radius: 14px; padding: 10px 18px;
    border: 2px solid #d0e0f0; min-width: 64px;
  }
  .frac-display .n, .frac-display .d {
    font-family: 'Fredoka', sans-serif; font-size: 26px; font-weight: 700; color: var(--text); line-height: 1.1;
  }
  .frac-display .line { width: 36px; height: 3px; background: var(--text); border-radius: 2px; }
  .op-sign {
    font-family: 'Fredoka', sans-serif; font-size: 28px; font-weight: 700; color: var(--accent);
  }

  /* Choices */
  .choices { display: flex; flex-direction: column; gap: 10px; }
  .choice-btn {
    display: flex; align-items: center; justify-content: center; gap: 10px;
    padding: 14px; border-radius: 14px;
    border: 2px solid #d0e0f0; background: white;
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 15px; font-weight: 900; color: var(--text);
    cursor: pointer; transition: all 0.2s;
  }
  .choice-btn:hover { border-color: var(--accent); background: #f0f6ff; }
  .choice-btn:active { transform: scale(0.97); }
  .choice-btn .cf { display: inline-flex; flex-direction: column; align-items: center; }
  .choice-btn .cf .cn, .choice-btn .cf .cd { font-family: 'Fredoka', sans-serif; font-size: 22px; line-height: 1.1; }
  .choice-btn .cf .cl { width: 30px; height: 3px; background: var(--text); border-radius: 2px; }
  .choice-btn.correct { border-color: var(--green); background: #e8f8f0; }
  .choice-btn.wrong { border-color: var(--red); background: #fde8e8; }
  .choice-btn.disabled { pointer-events: none; }
  .choice-btn.dim { opacity: 0.4; }

  .feedback {
    margin-top: 14px; padding: 12px 16px; border-radius: 12px;
    font-size: 14px; font-weight: 900; animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  .feedback.ok { background: #e8f8f0; color: var(--green); }
  .feedback.ng { background: #fde8e8; color: var(--red); }
  .feedback .explain { font-size: 12px; font-weight: 700; color: var(--text-mid); margin-top: 6px; line-height: 1.7; }

  .next-btn {
    display: block; width: 100%; margin-top: 14px; padding: 14px;
    border-radius: 14px; border: none;
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    color: white; font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 15px; font-weight: 900; cursor: pointer;
  }
  .next-btn:active { transform: scale(0.97); }

  /* Final */
  .final-area { text-align: center; padding-top: 30px; }
  .final-icon { font-size: 64px; margin-bottom: 10px; animation: pulse 2s ease-in-out infinite; }
  .final-title { font-size: 22px; font-weight: 900; margin-bottom: 16px; }
  .score-card {
    background: var(--card); border-radius: 20px; padding: 24px;
    border: 2px solid #d0e0f0; margin-bottom: 20px;
  }
  .score-big { font-family: 'Fredoka', sans-serif; font-size: 56px; font-weight: 700; color: var(--accent); }
  .score-sub { font-size: 14px; color: var(--text-mid); font-weight: 700; }
  .rank-badge {
    display: inline-block; margin-top: 12px; padding: 8px 24px;
    border-radius: 12px; font-size: 16px; font-weight: 900;
  }
  .rank-s { background: linear-gradient(135deg, #ffd700, #ffec8b); color: #8b6914; }
  .rank-a { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); color: #555; }
  .rank-b { background: linear-gradient(135deg, #cd7f32, #daa06d); color: #4a2800; }
  .rank-c { background: #e0e8f0; color: var(--text-mid); }
  .retry-btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 14px 36px; border-radius: 14px; border: none;
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    color: white; font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 16px; font-weight: 900; cursor: pointer;
    box-shadow: 0 4px 16px var(--accent-glow); margin-bottom: 12px;
  }
  .retry-btn:active { transform: scale(0.96); }
  .home-link {
    display: block; font-size: 13px; color: var(--text-mid);
    text-decoration: none; font-weight: 700; margin-top: 8px;
  }
  .home-link:hover { color: var(--accent); }
</style>
</head>
<body>

<header class="game-header">
  <a class="back-btn" href="../" aria-label="ã‚‚ã©ã‚‹">â†</a>
  <div class="header-emoji">ğŸ”¬</div>
  <div class="header-title">åˆ†æ•°èåˆ</div>
  <div class="header-sub">åˆ†æ•°ã‚’ãŸã—ã¦ç›®æ¨™ã®æ•°ã‚’ã¤ãã‚ã†ï¼</div>
</header>

<div class="container">
  <div class="screen active" id="startScreen">
    <div class="start-area">
      <div class="start-icon">ğŸ§ª</div>
      <div class="start-title">åˆ†æ•°ã‚’åˆä½“ã•ã›ã‚ˆã†ï¼</div>
      <div class="start-desc">
        2ã¤ã®åˆ†æ•°ã‚’ãŸã—ã¦<br>ç›®æ¨™ã®åˆ†æ•°ã‚’ã¤ãã‚Œã‚‹ã‹ãªï¼Ÿ<br>
        æ­£ã—ã„ç­”ãˆã‚’ãˆã‚‰ã¼ã†ï¼
      </div>
      <div class="rules-box">
        <h3>ğŸ“‹ ã‚ãã³ã‹ãŸ</h3>
        <ul>
          <li>ç›®æ¨™ã®åˆ†æ•°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆ</li>
          <li>2ã¤ã®åˆ†æ•°ã®è¶³ã—ç®—ã®ç­”ãˆã‚’ãˆã‚‰ã¼ã†</li>
          <li>å…¨10å•ï¼é«˜å¾—ç‚¹ã‚’ã‚ã–ãã†</li>
          <li>ã¯ã‚„ãç­”ãˆã‚‹ã¨ãƒœãƒ¼ãƒŠã‚¹ç‚¹ï¼</li>
        </ul>
      </div>
      <button class="start-btn" id="startBtn">ğŸ§ª ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    </div>
  </div>

  <div class="screen" id="gameScreen">
    <div class="hud">
      <div class="hud-item"><span>â­</span><span class="hud-score" id="hudScore">0</span></div>
      <div class="hud-item hud-round" id="hudRound">ç¬¬1å• / 10å•</div>
      <div class="hud-item"><span>â±</span><span class="hud-timer" id="hudTimer">15</span></div>
    </div>
    <div id="questionArea"></div>
  </div>

  <div class="screen" id="finalScreen"></div>
</div>

<script>
  // Utility
  function gcd(a, b) { a = Math.abs(a); b = Math.abs(b); while (b) { var t = b; b = a % b; a = t; } return a; }
  function simplify(n, d) { var g = gcd(n, d); return [n / g, d / g]; }
  function addFractions(n1, d1, n2, d2) {
    var n = n1 * d2 + n2 * d1;
    var d = d1 * d2;
    return simplify(n, d);
  }
  function fracEqual(n1, d1, n2, d2) {
    var a = simplify(n1, d1);
    var b = simplify(n2, d2);
    return a[0] === b[0] && a[1] === b[1];
  }
  function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
  function shuffle(arr) {
    for (var i = arr.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var t = arr[i]; arr[i] = arr[j]; arr[j] = t;
    }
    return arr;
  }

  // Generate a question
  function makeQuestion() {
    var d1 = randInt(2, 8);
    var d2 = randInt(2, 8);
    var n1 = randInt(1, d1 - 1);
    var n2 = randInt(1, d2 - 1);
    var ans = addFractions(n1, d1, n2, d2);

    // Make wrong answers
    var wrongs = [];
    var tries = 0;
    while (wrongs.length < 3 && tries < 50) {
      tries++;
      var wn = ans[0] + randInt(-3, 3);
      var wd = ans[1] + randInt(-2, 2);
      if (wd < 2) wd = 2;
      if (wn < 1) wn = 1;
      var ws = simplify(wn, wd);
      if (fracEqual(ws[0], ws[1], ans[0], ans[1])) continue;
      var dup = false;
      for (var i = 0; i < wrongs.length; i++) {
        if (fracEqual(wrongs[i][0], wrongs[i][1], ws[0], ws[1])) { dup = true; break; }
      }
      if (!dup) wrongs.push(ws);
    }
    // Fallback wrongs
    while (wrongs.length < 3) {
      wrongs.push([ans[0] + wrongs.length + 1, ans[1]]);
    }

    var options = [ans].concat(wrongs);
    shuffle(options);
    var correctIdx = -1;
    for (var i = 0; i < options.length; i++) {
      if (fracEqual(options[i][0], options[i][1], ans[0], ans[1])) { correctIdx = i; break; }
    }

    return {
      n1: n1, d1: d1, n2: n2, d2: d2,
      ansN: ans[0], ansD: ans[1],
      options: options, correctIdx: correctIdx
    };
  }

  // State
  var TOTAL = 10;
  var TIME_PER_Q = 15;
  var score = 0, round = 0, correctCount = 0;
  var timer, timeLeft;

  var startScreen = document.getElementById('startScreen');
  var gameScreen = document.getElementById('gameScreen');
  var finalScreen = document.getElementById('finalScreen');
  var questionArea = document.getElementById('questionArea');
  var hudScore = document.getElementById('hudScore');
  var hudRound = document.getElementById('hudRound');
  var hudTimer = document.getElementById('hudTimer');

  function showScreen(s) {
    [startScreen, gameScreen, finalScreen].forEach(function(el) { el.classList.remove('active'); });
    s.classList.add('active');
  }

  document.getElementById('startBtn').addEventListener('click', function() {
    score = 0; round = 0; correctCount = 0;
    showScreen(gameScreen);
    nextQuestion();
  });

  function nextQuestion() {
    round++;
    if (round > TOTAL) { showFinal(); return; }
    hudScore.textContent = score;
    hudRound.textContent = 'ç¬¬' + round + 'å• / ' + TOTAL + 'å•';
    timeLeft = TIME_PER_Q;
    hudTimer.textContent = timeLeft;

    var q = makeQuestion();
    renderQuestion(q);

    clearInterval(timer);
    timer = setInterval(function() {
      timeLeft--;
      hudTimer.textContent = timeLeft;
      if (timeLeft <= 0) {
        clearInterval(timer);
        handleAnswer(q, -1);
      }
    }, 1000);
  }

  function fracHtml(n, d) {
    return '<span class="cf"><span class="cn">' + n + '</span><span class="cl"></span><span class="cd">' + d + '</span></span>';
  }

  function renderQuestion(q) {
    var choicesHtml = '';
    for (var i = 0; i < q.options.length; i++) {
      choicesHtml += '<button class="choice-btn" data-idx="' + i + '">' + fracHtml(q.options[i][0], q.options[i][1]) + '</button>';
    }

    questionArea.innerHTML =
      '<div class="fusion-card">' +
        '<div class="fusion-label">ã“ã®è¶³ã—ç®—ã®ç­”ãˆã¯ï¼Ÿ</div>' +
        '<div class="operands">' +
          '<div class="frac-display"><span class="n">' + q.n1 + '</span><span class="line"></span><span class="d">' + q.d1 + '</span></div>' +
          '<span class="op-sign">+</span>' +
          '<div class="frac-display"><span class="n">' + q.n2 + '</span><span class="line"></span><span class="d">' + q.d2 + '</span></div>' +
          '<span class="op-sign">=</span>' +
          '<span class="op-sign">ï¼Ÿ</span>' +
        '</div>' +
        '<div class="choices" id="choices">' + choicesHtml + '</div>' +
        '<div id="feedbackArea"></div>' +
      '</div>';

    var btns = document.querySelectorAll('.choice-btn');
    btns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        handleAnswer(q, parseInt(btn.dataset.idx));
      });
    });
  }

  function handleAnswer(q, chosen) {
    clearInterval(timer);
    var isCorrect = chosen === q.correctIdx;
    var bonus = isCorrect ? Math.max(0, timeLeft * 2) : 0;
    var pts = isCorrect ? 10 + bonus : 0;
    score += pts;
    if (isCorrect) correctCount++;
    hudScore.textContent = score;

    var btns = document.querySelectorAll('.choice-btn');
    btns.forEach(function(btn, i) {
      btn.classList.add('disabled');
      if (i === q.correctIdx) btn.classList.add('correct');
      if (i === chosen && !isCorrect) btn.classList.add('wrong');
      if (i !== q.correctIdx && i !== chosen) btn.classList.add('dim');
    });

    var fb = document.getElementById('feedbackArea');
    if (chosen < 0) {
      fb.innerHTML = '<div class="feedback ng">â° æ™‚é–“åˆ‡ã‚Œï¼ç­”ãˆã¯ ' + q.ansN + '/' + q.ansD + ' ã ã‚ˆ</div>';
    } else if (isCorrect) {
      fb.innerHTML = '<div class="feedback ok">ğŸ‰ æ­£è§£ï¼ +' + pts + 'ç‚¹' +
        (bonus > 0 ? 'ï¼ˆã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹ +' + bonus + 'ï¼‰' : '') + '</div>';
    } else {
      fb.innerHTML = '<div class="feedback ng">âŒ æ®‹å¿µï¼ç­”ãˆã¯ ' + q.ansN + '/' + q.ansD + ' ã ã‚ˆ' +
        '<div class="explain">é€šåˆ†ã™ã‚‹ã¨ ' + q.n1 + '/' + q.d1 + ' + ' + q.n2 + '/' + q.d2 +
        ' = ' + (q.n1 * q.d2) + '/' + (q.d1 * q.d2) + ' + ' + (q.n2 * q.d1) + '/' + (q.d1 * q.d2) +
        ' = ' + (q.n1 * q.d2 + q.n2 * q.d1) + '/' + (q.d1 * q.d2) + '</div></div>';
    }

    fb.innerHTML += '<button class="next-btn" id="nextBtn">' +
      (round < TOTAL ? 'æ¬¡ã®å•é¡Œã¸ âœ' : 'çµæœã‚’è¦‹ã‚‹ ğŸ†') + '</button>';
    document.getElementById('nextBtn').addEventListener('click', nextQuestion);
  }

  function showFinal() {
    var maxBase = TOTAL * 10;
    var pct = Math.round(correctCount / TOTAL * 100);
    var rank, rankClass, emoji, label;
    if (pct >= 90) { rank = 'S'; rankClass = 'rank-s'; emoji = 'ğŸ‘‘'; label = 'åˆ†æ•°ãƒã‚¹ã‚¿ãƒ¼ï¼'; }
    else if (pct >= 70) { rank = 'A'; rankClass = 'rank-a'; emoji = 'ğŸ–ï¸'; label = 'åˆ†æ•°ã¯ã‹ã›ï¼'; }
    else if (pct >= 50) { rank = 'B'; rankClass = 'rank-b'; emoji = 'ğŸ“š'; label = 'åˆ†æ•°ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼ï¼'; }
    else { rank = 'C'; rankClass = 'rank-c'; emoji = 'ğŸŒ±'; label = 'ã‚‚ã£ã¨ã‚Œã‚“ã—ã‚…ã†ï¼'; }

    finalScreen.innerHTML =
      '<div class="final-area">' +
        '<div class="final-icon">' + emoji + '</div>' +
        '<div class="final-title">ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</div>' +
        '<div class="score-card">' +
          '<div class="score-big">' + score + '</div>' +
          '<div class="score-sub">' + correctCount + ' / ' + TOTAL + ' å•æ­£è§£</div>' +
          '<div class="rank-badge ' + rankClass + '">' + emoji + ' ãƒ©ãƒ³ã‚¯ ' + rank + 'ã€Œ' + label + 'ã€</div>' +
        '</div>' +
        '<button class="retry-btn" id="retryBtn">ğŸ”„ ã‚‚ã†ä¸€åº¦ã‚ãã¶</button>' +
        '<a class="home-link" href="../">ğŸŒ² ã‚²ãƒ¼ãƒ ãƒ©ãƒ³ãƒ‰ã«æˆ»ã‚‹</a>' +
      '</div>';
    showScreen(finalScreen);
    document.getElementById('retryBtn').addEventListener('click', function() {
      score = 0; round = 0; correctCount = 0;
      showScreen(gameScreen);
      nextQuestion();
    });
  }
</script>
</body>
</html>
