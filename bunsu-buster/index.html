<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÂàÜÊï∞„Éê„Çπ„Çø„ÉºÔºÅü•ß</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg: #1a1a2e;
    --accent: #e94560;
    --gold: #ffd700;
    --success: #00e676;
    --text: #f0f0f0;
    --blue-glow: #4ecdc4;
    --red-glow: #ff4757;
  }
  body {
    font-family: 'Zen Maru Gothic', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow: hidden;
    user-select: none;
    -webkit-user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  .game-container {
    width: 100vw; height: 100vh;
    display: flex; flex-direction: column; align-items: center;
    position: relative; overflow: hidden;
  }
  /* Background */
  .bg-particles {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 0;
  }
  .bg-particle {
    position: absolute; border-radius: 50%; opacity: 0.12;
    animation: float-particle 8s ease-in-out infinite;
  }
  @keyframes float-particle {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-30px) rotate(180deg); }
  }
  /* Header */
  .header {
    z-index: 10; display: flex; align-items: center; justify-content: space-between;
    width: 100%; max-width: 700px; padding: 12px 20px 4px; gap: 8px;
  }
  .diff-badge {
    padding: 3px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 900;
  }
  .diff-badge.easy { background: #4ecdc4; color: #1a1a2e; }
  .diff-badge.normal { background: #feca57; color: #1a1a2e; }
  .diff-badge.hard { background: #ff6b6b; color: #fff; }
  .score-display {
    display: flex; align-items: center; gap: 6px;
    font-size: 1.1rem; font-weight: 700;
  }
  .score-display .star { color: var(--gold); font-size: 1.2rem; }
  .combo-display {
    font-size: 0.85rem; color: var(--gold); font-weight: 700;
    opacity: 0; transition: opacity 0.3s;
  }
  .combo-display.active { opacity: 1; animation: combo-pulse 0.4s ease; }
  @keyframes combo-pulse {
    0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); }
  }
  /* Timer */
  .timer-area {
    width: 100%; max-width: 700px; padding: 4px 20px;
    z-index: 10; display: flex; align-items: center; gap: 10px;
  }
  .timer-bar-track {
    flex: 1; height: 12px; background: rgba(255,255,255,0.08);
    border-radius: 6px; overflow: hidden;
  }
  .timer-bar-fill {
    height: 100%; border-radius: 6px;
    transition: width 0.15s linear, background 0.3s;
    background: linear-gradient(90deg, #4ecdc4, var(--gold));
  }
  .timer-bar-fill.danger { background: linear-gradient(90deg, var(--accent), #ff6b6b); }
  .timer-text {
    font-size: 1.2rem; font-weight: 900; min-width: 48px;
    text-align: right; font-variant-numeric: tabular-nums;
  }
  .timer-text.danger { color: var(--accent); }
  .time-bonus-float {
    position: fixed; font-size: 1.2rem; font-weight: 900;
    color: #4ecdc4; pointer-events: none; z-index: 200;
    animation: time-bonus-up 1s ease-out forwards;
    text-shadow: 0 0 10px rgba(78,205,196,0.7);
  }
  @keyframes time-bonus-up {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-50px) scale(1.3); }
  }
  /* Countdown effect */
  .countdown-num {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 8rem; font-weight: 900;
    color: var(--accent);
    pointer-events: none; z-index: 180;
    text-shadow: 0 0 40px rgba(233,69,96,0.6), 0 0 80px rgba(233,69,96,0.3);
    animation: countdown-pop 0.9s ease-out forwards;
  }
  @keyframes countdown-pop {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(2.5); }
    15% { opacity: 0.9; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 0.7; transform: translate(-50%, -50%) scale(1.05); }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.6); }
  }
  /* Screen flash at each countdown tick */
  .screen-flash {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 170;
    animation: flash-red 0.3s ease-out forwards;
  }
  @keyframes flash-red {
    0% { background: rgba(233,69,96,0.15); }
    100% { background: rgba(233,69,96,0); }
  }
  /* Timer pulse when counting down */
  .timer-text.countdown-pulse {
    animation: timer-throb 0.4s ease;
  }
  @keyframes timer-throb {
    0% { transform: scale(1); }
    30% { transform: scale(1.5); color: var(--accent); }
    100% { transform: scale(1); }
  }
  /* Play area */
  .play-area {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 10; gap: 12px; padding: 0 20px;
    width: 100%; max-width: 700px;
  }
  .question-text {
    font-size: 1.05rem; font-weight: 700; text-align: center; color: #aaa;
  }
  /* Pie */
  .pie-wrapper {
    position: relative; width: 210px; height: 210px;
    display: flex; align-items: center; justify-content: center;
  }
  .pie-chart {
    width: 190px; height: 190px; border-radius: 50%; position: relative;
    box-shadow: 0 8px 40px rgba(0,0,0,0.5), inset 0 0 30px rgba(255,255,255,0.05);
    overflow: hidden; transition: transform 0.15s ease;
  }
  .pie-chart canvas { width: 100%; height: 100%; }
  .shatter-container {
    position: absolute; top: 0; left: 0;
    width: 210px; height: 210px; pointer-events: none; z-index: 50;
  }
  .shard { position: absolute; opacity: 1; }
  @keyframes shard-fly {
    0% { opacity: 1; transform: translate(0,0) rotate(0deg) scale(1); }
    100% { opacity: 0; transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(0.2); }
  }
  .sparkle-burst { position: absolute; top: 50%; left: 50%; pointer-events: none; z-index: 51; }
  .sparkle { position: absolute; border-radius: 50%; animation: sparkle-fly 0.7s ease-out forwards; }
  @keyframes sparkle-fly {
    0% { opacity: 1; transform: translate(0,0) scale(1); }
    100% { opacity: 0; transform: translate(var(--sx), var(--sy)) scale(0); }
  }
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-10px); } 40% { transform: translateX(10px); }
    60% { transform: translateX(-6px); } 80% { transform: translateX(6px); }
  }
  .pie-chart.shake { animation: shake 0.4s ease; }
  .pie-chart.entering { animation: pie-enter 0.3s ease-out; }
  @keyframes pie-enter {
    0% { transform: scale(0.3) rotate(-20deg); opacity: 0; }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
  }
  /* Cards */
  .cards-area {
    display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
    z-index: 10; padding: 6px 16px 24px;
    width: 100%; max-width: 700px;
  }
  .fraction-card {
    background: linear-gradient(145deg, #1e2a4a, #253565);
    border: 3px solid #3a4a7a; border-radius: 14px;
    padding: 10px 16px; cursor: pointer;
    transition: transform 0.15s, box-shadow 0.2s, border-color 0.2s, background 0.2s;
    display: flex; flex-direction: column; align-items: center;
    min-width: 62px; position: relative;
  }
  .fraction-card:hover:not(.armed):not(.disabled) {
    border-color: var(--blue-glow);
    box-shadow: 0 0 18px rgba(78,205,196,0.45), 0 4px 15px rgba(78,205,196,0.2);
    transform: translateY(-3px) scale(1.04);
    background: linear-gradient(145deg, #1a3050, #1e3a6a);
  }
  .fraction-card.armed {
    border-color: var(--red-glow);
    box-shadow: 0 0 22px rgba(255,71,87,0.5), 0 0 50px rgba(255,71,87,0.15);
    transform: translateY(-2px) scale(1.07);
    background: linear-gradient(145deg, #3a1a2a, #4a2040);
    animation: armed-pulse 0.8s ease-in-out infinite alternate;
  }
  @keyframes armed-pulse {
    0% { box-shadow: 0 0 18px rgba(255,71,87,0.4), 0 0 40px rgba(255,71,87,0.1); }
    100% { box-shadow: 0 0 28px rgba(255,71,87,0.65), 0 0 60px rgba(255,71,87,0.2); }
  }
  .fraction-card:active:not(.disabled) { transform: scale(0.95); }
  .fraction-card.disabled { opacity: 0.2; pointer-events: none; border-color: #333; box-shadow: none; }
  .fraction-card .numerator {
    font-size: 1.4rem; font-weight: 900; color: #4ecdc4; line-height: 1; transition: color 0.2s;
  }
  .fraction-card .fraction-bar {
    width: 32px; height: 3px; background: #6a7abf;
    margin: 3px 0; border-radius: 2px; transition: background 0.2s;
  }
  .fraction-card .denominator {
    font-size: 1.4rem; font-weight: 900; color: #ff6b6b; line-height: 1; transition: color 0.2s;
  }
  .fraction-card.armed .numerator { color: #ff9aa2; }
  .fraction-card.armed .fraction-bar { background: #ff6b6b; }
  .fraction-card.armed .denominator { color: #ffb3b3; }
  .fraction-card .armed-label {
    position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
    font-size: 0.55rem; font-weight: 900; color: var(--red-glow);
    background: rgba(26,26,46,0.95); padding: 1px 7px; border-radius: 8px;
    opacity: 0; transition: opacity 0.2s; white-space: nowrap; pointer-events: none;
  }
  .fraction-card.armed .armed-label { opacity: 1; }
  /* Screens */
  .screen-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(10,10,20,0.93);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 200; gap: 16px; backdrop-filter: blur(10px);
  }
  .screen-overlay.hidden { display: none; }
  .screen-title {
    font-size: 2.2rem; font-weight: 900;
    background: linear-gradient(135deg, var(--gold), #ff6b6b, #4ecdc4);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text; text-align: center; line-height: 1.3;
  }
  .screen-subtitle {
    font-size: 0.95rem; color: #999; text-align: center;
    max-width: 340px; line-height: 1.7;
  }
  /* Difficulty buttons */
  .diff-buttons { display: flex; gap: 12px; margin-top: 8px; flex-wrap: wrap; justify-content: center; }
  .diff-btn {
    border: none; padding: 14px 28px; border-radius: 16px;
    font-size: 1rem; font-weight: 900;
    font-family: 'Zen Maru Gothic', sans-serif; cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex; flex-direction: column; align-items: center; gap: 4px;
    min-width: 110px;
  }
  .diff-btn:hover { transform: translateY(-3px) scale(1.05); }
  .diff-btn:active { transform: scale(0.96); }
  .diff-btn .diff-label { font-size: 1.1rem; }
  .diff-btn .diff-desc { font-size: 0.65rem; opacity: 0.8; }
  .diff-btn.easy {
    background: linear-gradient(135deg, #4ecdc4, #44bd9f);
    color: #1a1a2e; box-shadow: 0 6px 20px rgba(78,205,196,0.4);
  }
  .diff-btn.normal {
    background: linear-gradient(135deg, #feca57, #f0b429);
    color: #1a1a2e; box-shadow: 0 6px 20px rgba(254,202,87,0.4);
  }
  .diff-btn.hard {
    background: linear-gradient(135deg, #ff6b6b, #e94560);
    color: #fff; box-shadow: 0 6px 20px rgba(233,69,96,0.4);
  }
  .btn {
    background: linear-gradient(135deg, var(--accent), #ff6b6b);
    color: white; border: none; padding: 14px 40px;
    border-radius: 30px; font-size: 1.15rem; font-weight: 900;
    font-family: 'Zen Maru Gothic', sans-serif; cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 6px 20px rgba(233,69,96,0.4); margin-top: 6px;
  }
  .btn:hover { transform: translateY(-2px) scale(1.04); }
  .btn:active { transform: scale(0.97); }
  /* Popup */
  .result-popup {
    position: fixed; top: 45%; left: 50%; transform: translate(-50%, -50%);
    font-size: 2rem; font-weight: 900;
    z-index: 100; pointer-events: none; opacity: 0; white-space: nowrap;
  }
  .result-popup.correct { color: var(--success); animation: popup-correct 0.9s ease forwards; }
  .result-popup.wrong { color: var(--accent); animation: popup-wrong 0.7s ease forwards; }
  @keyframes popup-correct {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    15% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
    45% { opacity: 1; transform: translate(-50%, -60%) scale(1); }
    100% { opacity: 0; transform: translate(-50%, -80%) scale(0.8); }
  }
  @keyframes popup-wrong {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
    70% { opacity: 1; } 100% { opacity: 0; }
  }
  /* Stats */
  .final-stats { display: flex; gap: 24px; margin: 6px 0; }
  .stat-item { text-align: center; }
  .stat-value { font-size: 1.8rem; font-weight: 900; color: var(--gold); }
  .stat-label { font-size: 0.75rem; color: #777; margin-top: 2px; }
  /* Legend */
  .op-legend { display: flex; gap: 14px; justify-content: center; font-size: 0.7rem; }
  .op-legend-item { display: flex; align-items: center; gap: 4px; color: #555; }
  .op-dot { width: 8px; height: 8px; border-radius: 50%; }
  .op-dot.blue { background: var(--blue-glow); box-shadow: 0 0 5px rgba(78,205,196,0.5); }
  .op-dot.red { background: var(--red-glow); box-shadow: 0 0 5px rgba(255,71,87,0.5); }
  @media (max-width: 500px) {
    .pie-wrapper { width: 170px; height: 170px; }
    .pie-chart { width: 155px; height: 155px; }
    .fraction-card { padding: 8px 12px; min-width: 56px; }
    .fraction-card .numerator, .fraction-card .denominator { font-size: 1.2rem; }
    .screen-title { font-size: 1.7rem; }
    .diff-btn { min-width: 90px; padding: 12px 20px; }
  }
  @media (max-height: 650px) {
    .pie-wrapper { width: 150px; height: 150px; }
    .pie-chart { width: 135px; height: 135px; }
    .play-area { gap: 6px; }
    .cards-area { padding-bottom: 12px; gap: 8px; }
  }
</style>
</head>
<body>
<div class="game-container">
  <div class="bg-particles" id="bgParticles"></div>
  <!-- Start -->
  <div class="screen-overlay" id="startScreen">
    <div class="screen-title">ü•ß ÂàÜÊï∞„Éê„Çπ„Çø„ÉºÔºÅ</div>
    <div class="screen-subtitle">
      ÂÜÜ„Ç∞„É©„Éï„Å´Âêà„ÅÜÂàÜÊï∞„Ç´„Éº„Éâ„ÇíÈÅ∏„Çì„ÅßÂ£ä„Åù„ÅÜÔºÅ<br>
      <span style="color:var(--blue-glow);">üîµ „Éõ„Éê„Éº</span> ‚Üí
      <span style="color:var(--red-glow);">üî¥ „ÇØ„É™„ÉÉ„ÇØ</span> ‚Üí
      <span style="color:var(--gold);">üí• „ÇÇ„ÅÜ1Âõû„ÅßÊ±∫ÂÆö</span><br><br>
      ‚è± 30ÁßíÔºÅÈÄüÁ≠îÔºÜ„Ç≥„É≥„Éú„Åß+1Áßí
    </div>
    <div style="color:#aaa;font-size:0.95rem;font-weight:700;margin-top:4px;">Èõ£ÊòìÂ∫¶„Çí„Åà„Çâ„Åº„ÅÜ</div>
    <div class="diff-buttons">
      <button class="diff-btn easy" onclick="startGame('easy')">
        <span class="diff-label">üå± „Åã„Çì„Åü„Çì</span>
        <span class="diff-desc">1/2, 1/3, 3/4 „Å™„Å©</span>
      </button>
      <button class="diff-btn normal" onclick="startGame('normal')">
        <span class="diff-label">‚ö° „Åµ„Å§„ÅÜ</span>
        <span class="diff-desc">2/5, 5/8, 7/12 „Å™„Å©</span>
      </button>
      <button class="diff-btn hard" onclick="startGame('hard')">
        <span class="diff-label">üî• „ÇÄ„Åö„Åã„Åó„ÅÑ</span>
        <span class="diff-desc">7/16, 11/20, Á¥ÑÂàÜ„ÇÇ</span>
      </button>
    </div>
  </div>
  <!-- Game Over -->
  <div class="screen-overlay hidden" id="gameOverScreen">
    <div class="screen-title" id="gameOverTitle">‚è± ÁµÇ‰∫ÜÔºÅ</div>
    <div class="final-stats">
      <div class="stat-item">
        <div class="stat-value" id="finalScore">0</div>
        <div class="stat-label">„Çπ„Ç≥„Ç¢</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="finalCorrect">0</div>
        <div class="stat-label">Ê≠£Ëß£Êï∞</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="finalCombo">0</div>
        <div class="stat-label">ÊúÄÂ§ß„Ç≥„É≥„Éú</div>
      </div>
    </div>
    <div class="stat-item">
      <div class="stat-value" style="font-size:1.1rem;" id="finalAccuracy">0%</div>
      <div class="stat-label">Ê≠£Ëß£Áéá</div>
    </div>
    <div class="diff-buttons" style="margin-top:8px;">
      <button class="diff-btn easy" onclick="startGame('easy')">üå± „Åã„Çì„Åü„Çì</button>
      <button class="diff-btn normal" onclick="startGame('normal')">‚ö° „Åµ„Å§„ÅÜ</button>
      <button class="diff-btn hard" onclick="startGame('hard')">üî• „ÇÄ„Åö„Åã„Åó„ÅÑ</button>
    </div>
  </div>
  <!-- Header -->
  <div class="header">
    <div class="diff-badge" id="diffBadge">„Åã„Çì„Åü„Çì</div>
    <div class="score-display">
      <span class="star">‚≠ê</span>
      <span id="scoreText">0</span>
    </div>
    <div class="combo-display" id="comboDisplay">üî• x0</div>
    <div style="font-size:0.8rem;color:#666;" id="correctCount">Ê≠£Ëß£: 0</div>
  </div>
  <!-- Timer -->
  <div class="timer-area">
    <div class="timer-bar-track">
      <div class="timer-bar-fill" id="timerBarFill" style="width:100%"></div>
    </div>
    <div class="timer-text" id="timerText">30.0</div>
  </div>
  <!-- Play -->
  <div class="play-area">
    <div class="question-text" id="questionText">„Åì„ÅÆÂÜÜ„Ç∞„É©„Éï„ÅÆÂàÜÊï∞„ÅØÔºü</div>
    <div class="pie-wrapper" id="pieWrapper">
      <div class="pie-chart" id="pieChart">
        <canvas id="pieCanvas" width="400" height="400"></canvas>
      </div>
      <div class="shatter-container" id="shatterContainer"></div>
      <div class="sparkle-burst" id="sparkleBurst"></div>
    </div>
    <div class="op-legend">
      <div class="op-legend-item"><div class="op-dot blue"></div>„Éõ„Éê„Éº</div>
      <div class="op-legend-item"><div class="op-dot red"></div>ÈÅ∏Êäû</div>
      <div class="op-legend-item">üí• Ê±∫ÂÆö</div>
    </div>
  </div>
  <!-- Cards -->
  <div class="cards-area" id="cardsArea"></div>
</div>
<div class="result-popup" id="resultPopup"></div>
<script>
// ===================== STATE =====================
const state = {
  score: 0, combo: 0, maxCombo: 0,
  totalCorrect: 0, totalAttempts: 0,
  currentAnswer: null, isAnimating: false,
  timeLeft: 30.0, maxTime: 30.0,
  timerRAF: null, lastTimestamp: 0, gameRunning: false,
  questionStartTime: 0,
  mode: 'easy', // 'easy' | 'normal' | 'hard'
  armedCard: null, armedFrac: null,
  lastCountdownNum: 0, // track which countdown number was last shown
};
// ===================== FRACTION POOLS =====================
// Easy: simple fractions, 4 choices
const easyPool = [
  {n:1,d:2},{n:1,d:3},{n:2,d:3},
  {n:1,d:4},{n:2,d:4},{n:3,d:4},
  {n:1,d:5},{n:2,d:5},{n:3,d:5},{n:4,d:5},
  {n:1,d:6},{n:5,d:6},
];
// Normal: bigger denominators, 5 choices
const normalPool = [
  {n:1,d:3},{n:2,d:3},
  {n:1,d:4},{n:3,d:4},
  {n:1,d:5},{n:2,d:5},{n:3,d:5},{n:4,d:5},
  {n:1,d:6},{n:5,d:6},
  {n:1,d:8},{n:3,d:8},{n:5,d:8},{n:7,d:8},
  {n:1,d:10},{n:3,d:10},{n:7,d:10},{n:9,d:10},
  {n:1,d:12},{n:5,d:12},{n:7,d:12},{n:11,d:12},
];
// Hard: large denominators, equivalent fractions, 6 choices
// Includes tricky equivalents that look different
const hardPool = [
  {n:1,d:3},{n:2,d:6},{n:3,d:9},  // equivalents
  {n:1,d:4},{n:2,d:8},{n:3,d:12}, // equivalents
  {n:1,d:2},{n:2,d:4},{n:3,d:6},{n:4,d:8},{n:5,d:10}, // equivalents
  {n:2,d:3},{n:4,d:6},{n:6,d:9},  // equivalents
  {n:3,d:4},{n:6,d:8},{n:9,d:12}, // equivalents
  {n:3,d:5},{n:6,d:10},
  {n:1,d:7},{n:2,d:7},{n:3,d:7},{n:4,d:7},{n:5,d:7},{n:6,d:7},
  {n:1,d:9},{n:2,d:9},{n:4,d:9},{n:5,d:9},{n:7,d:9},{n:8,d:9},
  {n:3,d:16},{n:5,d:16},{n:7,d:16},{n:9,d:16},{n:11,d:16},{n:13,d:16},
  {n:1,d:20},{n:3,d:20},{n:7,d:20},{n:9,d:20},{n:11,d:20},{n:13,d:20},{n:17,d:20},{n:19,d:20},
];
const PIE_COLORS = ['#ff6b6b','#4ecdc4','#45b7d1','#96ceb4','#feca57','#ff9ff3','#54a0ff','#5f27cd','#a29bfe','#fd79a8','#00cec9','#fdcb6e'];
// ===================== HELPERS =====================
function gcd(a,b){return b===0?a:gcd(b,a%b);}
function simplify(n,d){const g=gcd(Math.abs(n),Math.abs(d));return{n:n/g,d:d/g};}
function fractionsEqual(a,b){const sa=simplify(a.n,a.d),sb=simplify(b.n,b.d);return sa.n===sb.n&&sa.d===sb.d;}
function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function pickRandom(arr){return arr[Math.floor(Math.random()*arr.length)];}
function getPool() {
  if (state.mode === 'easy') return easyPool;
  if (state.mode === 'normal') return normalPool;
  return hardPool;
}
function getNumDummies() {
  if (state.mode === 'easy') return 3;   // 4 total
  if (state.mode === 'normal') return 4;  // 5 total
  return 5;                               // 6 total
}
// ===================== DRAW PIE =====================
function drawPieChart(canvas, fraction) {
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height, cx = w/2, cy = h/2, r = w/2 - 10;
  ctx.clearRect(0, 0, w, h);
  // For display, use the simplified form to draw actual slices
  const s = simplify(fraction.n, fraction.d);
  const {n, d} = s;
  const sliceAngle = (2 * Math.PI) / d;
  const startOffset = -Math.PI / 2;
  for (let i = 0; i < d; i++) {
    const start = startOffset + i * sliceAngle, end = start + sliceAngle;
    ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, start, end); ctx.closePath();
    ctx.fillStyle = i < n ? PIE_COLORS[i % PIE_COLORS.length] : 'rgba(255,255,255,0.07)';
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.25)'; ctx.lineWidth = 2; ctx.stroke();
  }
  // In hard mode, also draw the actual denominator grid lines (unsimplified)
  if (state.mode === 'hard' && fraction.d !== s.d) {
    const actualSlice = (2 * Math.PI) / fraction.d;
    ctx.setLineDash([4, 4]);
    ctx.strokeStyle = 'rgba(255,255,255,0.15)'; ctx.lineWidth = 1;
    for (let i = 0; i < fraction.d; i++) {
      const angle = startOffset + i * actualSlice;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx + Math.cos(angle) * r, cy + Math.sin(angle) * r);
      ctx.stroke();
    }
    ctx.setLineDash([]);
  }
  ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.strokeStyle = 'rgba(255,255,255,0.4)'; ctx.lineWidth = 3; ctx.stroke();
  const grad = ctx.createRadialGradient(cx - r * 0.3, cy - r * 0.3, 0, cx, cy, r);
  grad.addColorStop(0, 'rgba(255,255,255,0.1)'); grad.addColorStop(1, 'rgba(255,255,255,0)');
  ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.fillStyle = grad; ctx.fill();
}
// ===================== SHATTER =====================
function shatterPie() {
  const container = document.getElementById('shatterContainer');
  const canvas = document.getElementById('pieCanvas');
  const pieEl = document.getElementById('pieChart');
  const imgData = canvas.toDataURL();
  pieEl.style.opacity = '0'; pieEl.style.transform = 'scale(0.7)';
  const cw = 210;
  for (let i = 0; i < 10; i++) {
    const shard = document.createElement('div'); shard.className = 'shard';
    const angle = (i / 10) * Math.PI * 2, dist = 60 + Math.random() * 100;
    const tx = Math.cos(angle) * dist, ty = Math.sin(angle) * dist;
    const rot = (Math.random() - 0.5) * 720, size = 22 + Math.random() * 35;
    const half = cw / 2;
    const ox = half + Math.cos(angle) * 30 - size / 2, oy = half + Math.sin(angle) * 30 - size / 2;
    const pts = []; for (let j = 0; j < 4 + Math.floor(Math.random() * 3); j++) pts.push(`${Math.random()*100}% ${Math.random()*100}%`);
    shard.style.cssText = `left:${ox}px;top:${oy}px;width:${size}px;height:${size}px;background-image:url(${imgData});background-size:${cw}px ${cw}px;background-position:-${ox}px -${oy}px;clip-path:polygon(${pts.join(',')});--tx:${tx}px;--ty:${ty}px;--rot:${rot}deg;animation:shard-fly 0.7s ease-out forwards;`;
    container.appendChild(shard);
  }
  spawnSparkles();
  setTimeout(() => { container.innerHTML = ''; }, 900);
}
function spawnSparkles() {
  const burst = document.getElementById('sparkleBurst');
  const colors = ['#ffd700','#ff6b6b','#4ecdc4','#fff','#ff9ff3'];
  for (let i = 0; i < 16; i++) {
    const s = document.createElement('div'); s.className = 'sparkle';
    const angle = Math.random() * Math.PI * 2, dist = 40 + Math.random() * 80;
    s.style.cssText = `--sx:${Math.cos(angle)*dist}px;--sy:${Math.sin(angle)*dist}px;background:${pickRandom(colors)};width:${3+Math.random()*5}px;height:${3+Math.random()*5}px;animation-duration:${0.4+Math.random()*0.4}s;`;
    burst.appendChild(s);
  }
  setTimeout(() => { burst.innerHTML = ''; }, 1000);
}
// ===================== TIMER =====================
function startTimer() {
  state.lastTimestamp = performance.now();
  function tick(now) {
    if (!state.gameRunning) return;
    const delta = (now - state.lastTimestamp) / 1000;
    state.lastTimestamp = now;
    state.timeLeft = Math.max(0, state.timeLeft - delta);
    updateTimerUI();
    // Countdown effect for last 5 seconds
    if (state.timeLeft <= 5 && state.timeLeft > 0) {
      const currentNum = Math.ceil(state.timeLeft);
      if (currentNum !== state.lastCountdownNum && currentNum >= 1 && currentNum <= 5) {
        state.lastCountdownNum = currentNum;
        showCountdown(currentNum);
      }
    }
    if (state.timeLeft <= 0) { endGame(); return; }
    state.timerRAF = requestAnimationFrame(tick);
  }
  state.timerRAF = requestAnimationFrame(tick);
}
function updateTimerUI() {
  const pct = (state.timeLeft / state.maxTime) * 100;
  const fill = document.getElementById('timerBarFill');
  const text = document.getElementById('timerText');
  fill.style.width = pct + '%';
  const danger = state.timeLeft <= 8;
  fill.classList.toggle('danger', danger);
  text.classList.toggle('danger', danger);
  text.textContent = state.timeLeft.toFixed(1);
}
function addTime(seconds) {
  state.timeLeft = Math.min(state.timeLeft + seconds, state.maxTime);
  updateTimerUI();
  const timerArea = document.querySelector('.timer-area');
  const rect = timerArea.getBoundingClientRect();
  const el = document.createElement('div');
  el.className = 'time-bonus-float';
  el.textContent = `+${seconds.toFixed(1)}Áßí`;
  el.style.left = (rect.left + rect.width * 0.5) + 'px';
  el.style.top = (rect.bottom + 5) + 'px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1000);
}
// ===================== COUNTDOWN =====================
function showCountdown(num) {
  // Big number
  const el = document.createElement('div');
  el.className = 'countdown-num';
  el.textContent = num;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 950);
  // Screen flash
  const flash = document.createElement('div');
  flash.className = 'screen-flash';
  document.body.appendChild(flash);
  setTimeout(() => flash.remove(), 350);
  // Timer text pulse
  const timerText = document.getElementById('timerText');
  timerText.classList.remove('countdown-pulse');
  void timerText.offsetWidth;
  timerText.classList.add('countdown-pulse');
  setTimeout(() => timerText.classList.remove('countdown-pulse'), 450);
}
// ===================== UI =====================
function updateScore() { document.getElementById('scoreText').textContent = state.score; }
function updateCombo() {
  const el = document.getElementById('comboDisplay');
  if (state.combo >= 2) {
    el.textContent = `üî• x${state.combo}`;
    el.classList.remove('active'); void el.offsetWidth; el.classList.add('active');
  } else { el.classList.remove('active'); }
}
function updateCorrectCount() { document.getElementById('correctCount').textContent = `Ê≠£Ëß£: ${state.totalCorrect}`; }
function showPopup(text, type) {
  const el = document.getElementById('resultPopup');
  el.textContent = text; el.className = 'result-popup ' + type;
  void el.offsetWidth; el.className = 'result-popup ' + type;
}
function clearArmed() {
  if (state.armedCard) state.armedCard.classList.remove('armed');
  state.armedCard = null; state.armedFrac = null;
}
// ===================== GENERATE QUESTION =====================
function generateQuestion() {
  clearArmed();
  const pool = getPool();
  const numDummies = getNumDummies();
  const answer = pickRandom(pool);
  state.currentAnswer = answer;
  state.questionStartTime = Date.now();
  // Generate dummies that aren't equivalent to answer
  const dummies = [];
  let attempts = 0;
  while (dummies.length < numDummies && attempts < 200) {
    attempts++;
    const c = pickRandom(pool);
    if (!fractionsEqual(c, answer) && !dummies.some(d => fractionsEqual(d, c))) {
      // For hard mode: also ensure dummies aren't visually identical
      // (different unsimplified form but same value is OK to include as traps - but we've excluded by fractionsEqual)
      dummies.push(c);
    }
  }
  // Fill remaining with wider pool if needed
  const allPools = [...easyPool, ...normalPool, ...hardPool];
  while (dummies.length < numDummies) {
    const c = pickRandom(allPools);
    if (!fractionsEqual(c, answer) && !dummies.some(d => fractionsEqual(d, c))) dummies.push(c);
  }
  const options = shuffle([answer, ...dummies]);
  const canvas = document.getElementById('pieCanvas');
  const pieEl = document.getElementById('pieChart');
  pieEl.style.opacity = '1'; pieEl.style.transform = 'scale(1)';
  pieEl.classList.remove('entering'); void pieEl.offsetWidth; pieEl.classList.add('entering');
  drawPieChart(canvas, answer);
  const cardsArea = document.getElementById('cardsArea');
  cardsArea.innerHTML = '';
  options.forEach((frac, idx) => {
    const card = document.createElement('div');
    card.className = 'fraction-card';
    card.innerHTML = `
      <span class="numerator">${frac.n}</span>
      <div class="fraction-bar"></div>
      <span class="denominator">${frac.d}</span>
      <div class="armed-label">„ÇÇ„ÅÜ1Âõû„ÅßÊ±∫ÂÆöÔºÅ</div>
    `;
    card.addEventListener('click', (e) => { e.preventDefault(); handleCardClick(frac, card); });
    card.addEventListener('touchend', (e) => { e.preventDefault(); handleCardClick(frac, card); });
    cardsArea.appendChild(card);
    card.style.opacity = '0'; card.style.transform = 'translateY(16px)';
    setTimeout(() => {
      card.style.transition = 'opacity 0.2s ease, transform 0.2s ease, box-shadow 0.2s, border-color 0.2s, background 0.2s';
      card.style.opacity = '1'; card.style.transform = 'translateY(0)';
    }, 40 + idx * 50);
  });
  const texts = state.mode === 'hard'
    ? ['„Åì„ÅÆÂÜÜ„Ç∞„É©„Éï„ÅÆÂàÜÊï∞„ÅØÔºüÔºàÁ¥ÑÂàÜ„Å´Ê≥®ÊÑèÔºÅÔºâ', 'Âêå„ÅòÂ§ß„Åç„Åï„ÅÆÂàÜÊï∞„ÇíË¶ã„Å§„Åë„Çà„ÅÜÔºÅ', 'Ê≠£„Åó„ÅÑÂàÜÊï∞„ÇíÈÅ∏„Åº„ÅÜÔºÅ']
    : ['„Åì„ÅÆÂÜÜ„Ç∞„É©„Éï„ÅÆÂàÜÊï∞„ÅØÔºü', 'Ëâ≤„ÅÆ„Å§„ÅÑ„ÅüÈÉ®ÂàÜ„ÅØ„Å©„ÇåÔºü', '„Éë„É™„É≥„Å®Â£ä„Åù„ÅÜÔºÅ'];
  document.getElementById('questionText').textContent = pickRandom(texts);
}
// ===================== CARD CLICK =====================
function handleCardClick(frac, card) {
  if (state.isAnimating || !state.gameRunning) return;
  if (state.armedCard === card) { confirmAnswer(frac, card); return; }
  clearArmed();
  card.classList.add('armed');
  state.armedCard = card;
  state.armedFrac = frac;
}
function confirmAnswer(frac, card) {
  if (state.isAnimating || !state.gameRunning) return;
  state.isAnimating = true;
  state.totalAttempts++;
  clearArmed();
  if (fractionsEqual(frac, state.currentAnswer)) {
    state.combo++;
    if (state.combo > state.maxCombo) state.maxCombo = state.combo;
    state.totalCorrect++;
    const points = 100 * Math.max(1, state.combo);
    state.score += points;
    updateScore(); updateCombo(); updateCorrectCount();
    shatterPie();
    const elapsed = (Date.now() - state.questionStartTime) / 1000;
    let timeBonus = 0;
    if (elapsed < 3) timeBonus = 1.0;
    if (state.combo >= 3) timeBonus += 1.0;
    if (timeBonus > 0) addTime(timeBonus);
    const popupText = state.combo >= 3 ? `üî• x${state.combo}  +${points}ÁÇπ` :
                      state.combo >= 2 ? `‚ú® „Ç≥„É≥„ÉúÔºÅ +${points}ÁÇπ` : 'üéâ Ê≠£Ëß£ÔºÅ';
    showPopup(popupText, 'correct');
    setTimeout(() => {
      if (!state.gameRunning) return;
      generateQuestion();
      state.isAnimating = false;
    }, 800);
  } else {
    state.combo = 0; updateCombo();
    const pieEl = document.getElementById('pieChart');
    pieEl.classList.add('shake');
    card.classList.add('disabled');
    showPopup('‚ùå „Å°„Åå„ÅÜ„ÇàÔºÅ', 'wrong');
    setTimeout(() => { pieEl.classList.remove('shake'); state.isAnimating = false; }, 450);
  }
}
document.addEventListener('click', (e) => {
  if (!state.armedCard) return;
  if (e.target.closest('.fraction-card')) return;
  clearArmed();
});
// ===================== GAME FLOW =====================
function startGame(mode) {
  document.getElementById('startScreen').classList.add('hidden');
  document.getElementById('gameOverScreen').classList.add('hidden');
  state.mode = mode;
  Object.assign(state, {
    score: 0, combo: 0, maxCombo: 0, totalCorrect: 0, totalAttempts: 0,
    isAnimating: false, timeLeft: 30.0, gameRunning: true, armedCard: null, armedFrac: null,
    lastCountdownNum: 0,
  });
  // Update badge
  const badge = document.getElementById('diffBadge');
  badge.className = 'diff-badge ' + mode;
  badge.textContent = mode === 'easy' ? 'üå± „Åã„Çì„Åü„Çì' : mode === 'normal' ? '‚ö° „Åµ„Å§„ÅÜ' : 'üî• „ÇÄ„Åö„Åã„Åó„ÅÑ';
  updateScore(); updateCombo(); updateCorrectCount(); updateTimerUI();
  if (state.timerRAF) cancelAnimationFrame(state.timerRAF);
  startTimer(); generateQuestion();
}
function endGame() {
  state.gameRunning = false;
  if (state.timerRAF) cancelAnimationFrame(state.timerRAF);
  setTimeout(() => {
    document.getElementById('finalScore').textContent = state.score;
    document.getElementById('finalCorrect').textContent = state.totalCorrect;
    document.getElementById('finalCombo').textContent = state.maxCombo;
    const acc = state.totalAttempts > 0 ? Math.round((state.totalCorrect / state.totalAttempts) * 100) : 0;
    document.getElementById('finalAccuracy').textContent = acc + '%';
    const title = state.totalCorrect >= 20 ? 'üëë ÂàÜÊï∞„Éû„Çπ„Çø„ÉºÔºÅ' :
                  state.totalCorrect >= 12 ? 'üéâ „Åô„Åî„ÅÑÔºÅ' :
                  state.totalCorrect >= 6 ? '‚ú® „Å™„Åã„Å™„ÅãÔºÅ' : '‚è± ÁµÇ‰∫ÜÔºÅ';
    document.getElementById('gameOverTitle').textContent = title;
    document.getElementById('gameOverScreen').classList.remove('hidden');
  }, 500);
}
// ===================== BG =====================
(function() {
  const c = document.getElementById('bgParticles');
  const colors = ['#ff6b6b','#4ecdc4','#ffd700','#ff9ff3','#54a0ff'];
  for (let i = 0; i < 18; i++) {
    const p = document.createElement('div'); p.className = 'bg-particle';
    const size = 4 + Math.random() * 18;
    p.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;width:${size}px;height:${size}px;background:${pickRandom(colors)};animation-delay:${Math.random()*5}s;animation-duration:${5+Math.random()*8}s;`;
    c.appendChild(p);
  }
})();
</script>
</body>
</html>
